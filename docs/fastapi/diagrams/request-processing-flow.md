# FastAPI 请求处理流程图表

## 1. 完整的请求处理管道

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           HTTP 请求处理管道                               │
│                                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐     │
│  │   客户端    │    │    ASGI     │    │  Starlette  │    │   FastAPI   │     │
│  │   Request   │───▶│   Server    │───▶│ Middleware  │───▶│   Router    │     │
│  │             │    │  (Uvicorn)  │    │    Stack    │    │             │     │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘     │
│                                                                   │             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐           │             │
│  │   Response  │    │  Response   │    │ Dependency  │←──────────┘             │
│  │ Serializer  │◄───│ Validator   │◄───│  Resolver   │                         │
│  │             │    │             │    │             │                         │
│  └─────────────┘    └─────────────┘    └─────────────┘                         │
│         │                                      │                               │
│         │            ┌─────────────┐           │                               │
│         └───────────▶│  Endpoint   │◄──────────┘                               │
│                      │  Function   │                                           │
│                      │ Execution   │                                           │
│                      └─────────────┘                                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 2. 详细请求流程与性能指标

```
请求到达 (T=0ms)
      │
      ▼
┌─────────────────────────────────────┐
│         ASGI 接口                   │  ◄─── O(1) - 常量时间
│   • 作用域创建                       │
│   • 接收/发送通道设置                  │
└─────────────────────────────────────┘
      │
      ▼ (T=0.1ms)
┌─────────────────────────────────────┐
│      中间件栈                       │  ◄─── O(k) - k 个中间件层
│   • CORS 处理                       │
│   • 身份验证                         │
│   • 性能监控                         │
│   • 错误处理设置                      │
└─────────────────────────────────────┘
      │
      ▼ (T=0.3ms)
┌─────────────────────────────────────┐
│       路由解析                       │  ◄─── O(log n) - 二分查找
│   • 路径模式匹配                   │                   编译正则表达式
│   • HTTP 方法验证                    │
│   • 路径参数提取                     │
└─────────────────────────────────────┘
      │
      ▼ (T=0.5ms)
┌─────────────────────────────────────┐
│    依赖解析                         │  ◄─── 缓存时 O(1)
│   • 依赖图遍历                       │       无缓存时 O(d)
│   • 缓存查找 (L1 → L2)             │       d = 依赖深度
│   • 异步依赖并行执行                 │
│   • 安全范围验证                     │
└─────────────────────────────────────┘
      │
      ▼ (T=1.2ms)
┌─────────────────────────────────────┐
│     参数验证                         │  ◄─── O(f) - f = 字段数量
│   • 路径参数                         │        可并行化
│   • 查询参数                         │
│   • 请求体 (异步)                   │
│   • 请求头                          │
└─────────────────────────────────────┘
      │
      ▼ (T=1.8ms)
┌─────────────────────────────────────┐
│     端点执行                         │  ◄─── 可变 (用户代码)
│   • 函数参数注入                     │
│   • 异步/同步检测                    │
│   • 异常处理                         │
└─────────────────────────────────────┘
      │
      ▼ (T=varies)
┌─────────────────────────────────────┐
│    响应处理                         │  ◄─── O(s) - s = 响应大小
│   • 响应模型验证                     │        使用 orjson 优化
│   • JSON 序列化                      │
│   • 响应头添加                       │
└─────────────────────────────────────┘
      │
      ▼ (T+2.5ms avg)
    响应到客户端
```

## 3. 依赖解析流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        依赖解析引擎                                             │
│                                                                                 │
│  请求参数                              依赖图                                   │
│  ┌─────────────────┐                 ┌─────────────────┐                       │
│  │ 路径: user_id    │                 │     get_db()    │                       │  
│  │ 查询: ?active    │                 │        │        │                       │
│  │ 正文: JSON 数据  │                 │        ▼        │                       │
│  │ 请求头: Auth      │                 │  get_settings() │                       │
│  └─────────────────┘                 │        │        │                       │
│           │                          │        ▼        │                       │
│           │                          │ get_current_    │                       │
│           │                          │   user()        │                       │
│           │                          │        │        │                       │
│           │                          │        ▼        │                       │
│           │                          │   endpoint()    │                       │
│           │                          └─────────────────┘                       │
│           │                                    │                               │
│           ▼                                    │                               │
│  ┌─────────────────────────────────────────────▼─────────────────────────────┐ │
│  │                    依赖缓存系统                                       │ │
│  │                                                                         │ │
│  │  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐           │ │
│  │  │ 请求范围       │   │ 会话范围       │   │  应用范围      │           │ │
│  │  │ 缓存           │   │ 缓存           │   │  缓存          │           │ │
│  │  │ (每请求)       │   │ (每用户)       │   │ (全局)        │           │ │
│  │  │               │   │               │   │               │           │ │
│  │  │ • 数据库会话    │   │ • 用户数据     │   │ • 配置        │           │ │
│  │  │ • 临时数据      │   │ • 权限         │   │ • 常量        │           │ │
│  │  └───────────────┘   └───────────────┘   └───────────────┘           │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                       │                                       │
│                                       ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐ │
│  │                    执行策略                                             │ │
│  │                                                                         │ │
│  │    ┌─────────────┐      ┌─────────────┐      ┌─────────────┐           │ │
│  │    │   缓存型      │      │   异步       │      │    同步     │           │ │
│  │    │ 依赖        │      │依赖         │      │依赖         │           │ │
│  │    │             │      │             │      │             │           │ │
│  │    │ O(1) 查找   │      │ 并行        │      │ 线程池     │           │ │
│  │    │ 立即        │      │ 执行        │      │ 执行        │           │ │
│  │    │ 返回        │      │ await       │      │ run_in_     │           │ │
│  │    │             │      │ gather()    │      │ threadpool  │           │ │
│  │    └─────────────┘      └─────────────┘      └─────────────┘           │ │
│  └─────────────────────────────────────────────────────────────────────────┘ │
│                                       │                                       │
│                                       ▼                                       │
│                         已解析依赖                                         │
│                         ┌─────────────────────┐                             │
│                         │ • 数据库会话         │                             │
│                         │ • 当前用户           │                             │
│                         │ • 配置               │                             │
│                         │ • 已验证输入         │                             │
│                         └─────────────────────┘                             │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. 异步请求处理架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         异步请求处理                                         │
│                                                                                 │
│   事件循环 (uvloop)                                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                         │   │
│   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐             │   │
│   │  │   请求 A     │  │   请求 B     │  │   请求 C     │             │   │
│   │  │               │  │               │  │               │             │   │
│   │  │ await db()    │  │ await cache() │  │ await api()   │             │   │
│   │  │      ↓        │  │      ↓        │  │      ↓        │             │   │
│   │  │   I/O 等待    │  │   I/O 等待    │  │   I/O 等待    │             │   │
│   │  │   (非阻塞)     │  │   (Redis)     │  │   (HTTP)      │             │   │
│   │  │   式)         │  │               │  │               │             │   │
│   │  └───────────────┘  └───────────────┘  └───────────────┘             │   │
│   │         │                  │                  │                       │   │
│   └─────────┼──────────────────┼──────────────────┼───────────────────────┘   │
│             │                  │                  │                           │
│             ▼                  ▼                  ▼                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                     I/O 子系统                                        │   │
│   │                                                                         │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│   │  │ 数据库      │  │   Redis     │  │  HTTP API   │  │ 文件系统   │   │   │
│   │  │ 连接        │  │ 连接        │  │ 连接        │  │    访问     │   │   │
│   │  │             │  │             │  │             │  │             │   │   │
│   │  │ PostgreSQL  │  │   缓存       │  │ 外部        │  │   日志      │   │   │
│   │  │ AsyncPG     │  │   查找      │  │ 服务       │  │   文件      │   │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                       │                                         │
│                                       ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                      线程池                                             │   │
│   │                  (用于CPU密集型任务)                                 │   │
│   │                                                                         │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│   │  │   线程      │  │   线程      │  │   线程      │  │   线程      │   │   │
│   │  │      1      │  │      2      │  │      3      │  │      4      │   │   │
│   │  │             │  │             │  │             │  │             │   │   │
│   │  │ CPU密集型   │  │ 同步依赖   │  │ 阻塞        │  │ 遗留        │   │   │
│   │  │ 计算        │  │ 执行        │  │ 操作        │  │ 库          │   │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│                          性能特征:                                          │
│   • 单线程异步处理: ~60,000 请求/秒                                │
│   • 并发连接限制: 每个实例 ~10,000+                             │
│   • 每连接内存使用: 基线 ~2KB                                     │
│   • CPU 利用率: I/O 密集型工作负载的高效性                              │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 5. 缓存架构层次

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         FastAPI 缓存架构                                   │
│                                                                                 │
│                              应用层                                          │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                                                                         │   │
│   │  @lru_cache(maxsize=1000)               @cached_dependency()            │   │
│   │  def expensive_function()               async def get_user()            │   │
│   │                                                                         │   │
│   └─────────────┬───────────────────────────────────┬───────────────────────┘   │
│                 │                                   │                           │
│                 ▼                                   ▼                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         L1 缓存 (内存)                                │   │
│   │                                                                         │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│   │  │  函数       │  │ 依赖        │  │   模型      │  │  响应       │   │   │
│   │  │   缓存      │  │   缓存      │  │   缓存      │  │   缓存      │   │   │
│   │  │             │  │             │  │             │  │             │   │   │
│   │  │ • LRU       │  │ • 请求       │  │ • Pydantic  │  │ • 序列化    │   │   │
│   │  │ • TTL       │  │   作用域     │  │   模型      │  │   JSON      │   │   │
│   │  │ • 10K 条目   │  │ • 弱引用     │  │ • 弱键      │  │ • 压缩      │   │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                       │                                         │
│                                       ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         L2 缓存 (Redis)                                 │   │
│   │                                                                         │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│   │  │   会话       │  │    用户      │  │  数据库     │  │    API      │   │   │
│   │  │   缓存       │  │   缓存       │  │   查询       │  │  响应       │   │   │
│   │  │             │  │             │  │   缓存       │  │   缓存       │   │   │
│   │  │ • 每用户     │  │ • 用户配置  │  │ • 查询       │  │ • 外部      │   │   │
│   │  │ • TTL 30分钟 │  │   数据       │  │   结果       │  │   API 调用  │   │   │
│   │  │ • 管道       │  │ • 设置       │  │ • 预备       │  │ • 可变TTL   │   │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                       │                                         │
│                                       ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                       L3 缓存 (数据库)                                │   │
│   │                                                                         │   │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │   │
│   │  │ 连接        │  │ 查询计划    │  │   缓冲      │  │   索引      │   │   │
│   │  │    池       │  │   缓存       │  │    池       │  │   缓存       │   │   │
│   │  │             │  │             │  │             │  │             │   │   │
│   │  │ • 池化       │  │ • 预备       │  │ • 页面       │  │ • B树       │   │   │
│   │  │   连接       │  │   语句       │  │   缓存       │  │   节点       │   │   │
│   │  │ • 健康       │  │ • 执行       │  │ • 共享       │  │ • 统计      │   │   │
│   │  │   检查       │  │   计划       │  │   缓冲区     │  │   缓存       │   │   │
│   │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│                           缓存命中率:                                            │
│                           • L1: 85-95% (热数据)                                │
│                           • L2: 60-80% (温数据)                               │  
│                           • L3: 40-60% (持久化数据)                         │
│                                                                                 │
│                         性能影响:                                              │
│                         • L1 命中: ~0.1ms                                     │
│                         • L2 命中: ~1-5ms                                     │
│                         • L3 命中: ~10-50ms                                   │
│                         • 缓存未命中: ~100-500ms                           │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 6. 后台任务处理流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        后台任务处理                                         │
│                                                                                 │
│    HTTP 请求处理                        后台任务处理                │
│    ┌─────────────────────┐                  ┌─────────────────────────────┐    │
│    │                     │                  │                             │    │
│    │  1. 处理请求     │                  │     任务队列              │    │
│    │     ↓               │                  │  ┌─────────────────────────┐ │    │
│    │  2. 生成           │                  │  │ 任务 1: 发送邮件    │ │    │
│    │     响应           │                  │  │ 任务 2: 更新分析    │ │    │
│    │     ↓               │                  │  │ 任务 3: 缓存预热    │ │    │
│    │  3. 发送响应     │───────────────── ▶  │ 任务 4: 清理文件    │ │    │
│    │     ↓               │   添加任务       │  │ 任务 5: 生成报告    │ │    │
│    │  4. 连接           │                  │  └─────────────────────────┘ │    │
│    │     关闭            │                  │             │               │    │
│    │                     │                  │             ▼               │    │
│    └─────────────────────┘                  │  ┌─────────────────────────┐ │    │
│                                             │  │    任务处理器         │ │    │
│    响应时间: ~50ms                       │  │                         │ │    │
│    (无后台任务延迟)                     │  │ • 批量处理            │ │    │
│                                             │  │ • 错误恢复            │ │    │
│                                             │  │ • 重试逻辑            │ │    │
│                                             │  │ • 进度跟踪            │ │    │
│                                             │  └─────────────────────────┘ │    │
│                                             │             │               │    │
│                                             │             ▼               │    │
│                                             │  ┌─────────────────────────┐ │    │
│                                             │  │   执行策略            │ │    │
│                                             │  │                         │ │    │
│                                             │  │  ┌─────┐  ┌─────┐       │ │    │
│                                             │  │  │异步 │  │同步 │       │ │    │
│                                             │  │  │任务 │  │任务 │       │ │    │
│                                             │  │  └─────┘  └─────┘       │ │    │
│                                             │  │     │        │          │ │    │
│                                             │  │     ▼        ▼          │ │    │
│                                             │  │ ┌─────┐  ┌──────┐      │ │    │
│                                             │  │ │事件 │  │线程  │      │ │    │
│                                             │  │ │循环 │  │ 池   │      │ │    │
│                                             │  │ └─────┘  └──────┘      │ │    │
│                                             │  └─────────────────────────┘ │    │
│                                             └─────────────────────────────┘    │
│                                                           │                     │
│                                                           ▼                     │
│    ┌─────────────────────────────────────────────────────────────────────────┐ │
│    │                         任务执行结果                                 │ │
│    │                                                                         │ │
│    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │ │
│    │  │   成功      │  │   失败      │  │   重试      │  │  完成      │   │ │
│    │  │             │  │             │  │             │  │             │   │ │
│    │  │ • 任务ID    │  │ • 错误日志  │  │ • 退避       │  │ • 结果      │   │ │
│    │  │ • 结果      │  │ • 堆栈       │  │ • 队列       │  │ • 指标      │   │ │
│    │  │ • 持续时间   │  │   跟踪       │  │   再次       │  │ • 清理      │   │ │
│    │  │ • 指标      │  │ • 重试       │  │ • 指数延迟  │  │   完成      │   │ │
│    │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │ │
│    └─────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│                          性能特征:                                          │
│                          • 响应不被后台任务延迟                        │
│                          • 任务处理: 100-1000/秒                            │
│                          • 指数退避重试                                  │
│                          • 内存高效的任务队列                               │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 7. 性能优化决策树

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                     FastAPI 性能优化                                       │
│                              决策树                                          │
│                                                                                 │
│                           ┌─────────────┐                                      │
│                           │  请求      │                                      │
│                           │   到达     │                                      │  
│                           └──────┬──────┘                                      │
│                                  │                                             │
│                                  ▼                                             │
│                        ┌─────────────────┐                                    │
│                        │  路由已知?     │                                    │
│                        └─────┬───────┬───┘                                    │
│                              │ 是    │ 否                                      │
│                              ▼       ▼                                        │
│                    ┌─────────────┐ ┌─────────────┐                           │
│                    │ 使用缓存    │ │ 编译       │                           │
│                    │ 路由信息    │ │ 路由       │                           │
│                    │ O(1)        │ │ O(log n)    │                           │
│                    └─────┬───────┘ └─────┬───────┘                           │
│                          │               │                                   │
│                          └───────┬───────┘                                   │
│                                  │                                           │
│                                  ▼                                           │
│                        ┌─────────────────┐                                  │
│                        │ 依赖          │                                  │
│                        │   已缓存?       │                                  │
│                        └─────┬───────┬───┘                                  │
│                              │ 是    │ 否                                    │
│                              ▼       ▼                                      │
│                    ┌─────────────┐ ┌─────────────┐                         │
│                    │ 返回        │ │ 解析       │                         │
│                    │ 缓存值      │ │ 依赖        │                         │
│                    │ Values O(1) │ │ O(d) depth  │                         │
│                    └─────┬───────┘ └─────┬───────┘                         │
│                          │               │                                 │
│                          └───────┬───────┘                                 │
│                                  │                                         │
│                                  ▼                                         │
│                        ┌─────────────────┐                                │
│                        │  异步或         │                                │
│                        │   同步?         │                                │
│                        └─────┬───────┬───┘                                │
│                              │异步   │同步                                 │
│                              ▼       ▼                                    │
│                    ┌─────────────┐ ┌─────────────┐                       │
│                    │ 原生执行    │ │ 线程池     │                       │
│                    │ 执行        │ │ 执行        │                       │
│                    │ ~0.1ms      │ │ ~1-5ms      │                       │
│                    └─────┬───────┘ └─────┬───────┘                       │
│                          │               │                               │
│                          └───────┬───────┘                               │
│                                  │                                       │
│                                  ▼                                       │
│                        ┌─────────────────┐                              │
│                        │ 响应          │                              │
│                        │ 可序列化?     │                              │
│                        └─────┬───────┬───┘                              │
│                              │简单  │复杂                            │
│                              ▼       ▼                                  │
│                    ┌─────────────┐ ┌─────────────┐                     │
│                    │ 快速 JSON   │ │ Pydantic    │                     │
│                    │ orjson      │ │ 验证        │                     │
│                    │ ~0.1ms      │ │ ~1-10ms     │                     │
│                    └─────┬───────┘ └─────┬───────┘                     │
│                          │               │                             │
│                          └───────┬───────┘                             │
│                                  │                                     │
│                                  ▼                                     │
│                          ┌───────────────┐                            │
│                          │   响应       │                            │
│                          │   到客户端   │                            │
│                          │   完成       │                            │
│                          └───────────────┘                            │
│                                                                        │
│                     应用的优化策略:                               │
│                     ┌─────────────────────────────────────────────┐   │
│                     │ • 路由编译和缓存                        │   │  
│                     │ • 多级依赖缓存                          │   │
│                     │ • 异步优先执行                          │   │
│                     │ • 同步操作的线程池                      │   │
│                     │ • 优化的 JSON 序列化                    │   │
│                     │ • 请求范围的资源管理                  │   │
│                     │ • 后台任务卸载                          │   │
│                     └─────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```