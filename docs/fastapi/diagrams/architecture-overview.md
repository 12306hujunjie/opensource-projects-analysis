# FastAPI 架构概述图表

## 1. 完整系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          FastAPI System Architecture                           │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                            Client Layer                                   │  │
│  │                                                                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │  │
│  │  │   Web App   │  │   Mobile    │  │    API      │  │    CLI      │    │  │
│  │  │  (Browser)  │  │    App      │  │   Client    │  │   Tools     │    │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │  │
│  └───────────┬───────────────────────────────────────────────────────────────┘  │
│              │ HTTP/HTTPS + WebSocket                                            │
│              ▼                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         负载均衡器                                        │  │
│  │                      (Nginx/HAProxy)                                      │  │
│  │                                                                           │  │
│  │   • SSL 终止             • 速率限制           • 请求路由                 │  │
│  │   • 压缩                 • 健康检查           • 静态文件服务             │  │
│  └───────────┬───────────────────────────────────────────────────────────────┘  │
│              │                                                                   │
│              ▼                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        ASGI 服务器层                                      │  │
│  │                      (Uvicorn/Gunicorn)                                   │  │
│  │                                                                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │  │
│  │  │  Instance   │  │  Instance   │  │  Instance   │  │  Instance   │    │  │
│  │  │      1      │  │      2      │  │      3      │  │      N      │    │  │
│  │  │             │  │             │  │             │  │             │    │  │
│  │  │ • 事件      │  │ • 工作进程  │  │ • 进程      │  │ • 自动      │    │  │
│  │  │   循环      │  │   进程      │  │   池        │  │   扩缩容    │    │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │  │
│  └───────────┬───────────────────────────────────────────────────────────────┘  │
│              │                                                                   │
│              ▼                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        FastAPI 应用程序                                   │  │
│  │                                                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                    中间件堆栈                                       │ │  │
│  │  │                                                                     │ │  │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │ │  │
│  │  │ │    CORS     │ │ Auth/JWT    │ │ Rate Limit  │ │Performance  │   │ │  │
│  │  │ │ 中间件      │ │ 中间件      │ │ 中间件      │ │ 监控        │   │ │  │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │ │  │
│  │  │                                                                     │ │  │
│  │  │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │ │  │
│  │  │ │   错误      │ │   请求      │ │    Gzip     │ │   自定义    │   │ │  │
│  │  │ │  处理       │ │    ID       │ │ 压缩        │ │ 中间件      │   │ │  │
│  │  │ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  │                                    │                                     │  │
│  │                                    ▼                                     │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                        路由系统                                    │ │  │
│  │  │                                                                     │ │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │ │  │
│  │  │  │   主要      │  │    API      │  │   管理      │                │ │  │
│  │  │  │   路由      │  │   路由      │  │   路由      │                │ │  │
│  │  │  │             │  │             │  │             │                │ │  │
│  │  │  │ /health     │  │ /api/v1/*   │  │ /admin/*    │                │ │  │
│  │  │  │ /metrics    │  │ /api/v2/*   │  │ /internal/* │                │ │  │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘                │ │  │
│  │  │                                                                     │ │  │
│  │  │       路由解析: O(log n) 使用编译正则表达式模式                    │ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  │                                    │                                     │  │
│  │                                    ▼                                     │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                    依赖注入系统                                    │ │  │
│  │  │                                                                     │ │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │ │  │
│  │  │  │   请求      │  │   会话      │  │应用程序     │                │ │  │
│  │  │  │   作用域    │  │   作用域    │  │   作用域    │                │ │  │
│  │  │  │             │  │             │  │             │                │ │  │
│  │  │  │ • 数据库    │  │ • 用户      │  │ • 配置      │                │ │  │
│  │  │  │   会话      │  │   上下文    │  │ • 服务      │                │ │  │
│  │  │  │ • 请求      │  │ • 认证      │  │ • 缓存      │                │ │  │
│  │  │  │   上下文    │  │   状态      │  │   池        │                │ │  │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘                │ │  │
│  │  │                                                                     │ │  │
│  │  │         智能缓存: 已解析依赖为 O(1)                               │ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  │                                    │                                     │  │
│  │                                    ▼                                     │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                   验证和序列化                                     │ │  │
│  │  │                                                                     │ │  │
│  │  │  ┌─────────────┐              ┌─────────────┐              ┌──────┐ │ │  │
│  │  │  │  请求       │              │  响应       │              │OpenAPI│ │ │  │
│  │  │  │ 验证        │◄────────────▶│序列化       │◄────────────▶│模式  │ │ │  │
│  │  │  │             │              │             │              │ Gen  │ │ │  │
│  │  │  │ • 路径      │              │ • 模型      │              │      │ │ │  │
│  │  │  │   参数      │              │   验证      │              │ • JSON│ │ │  │
│  │  │  │ • 查询      │              │ • JSON      │              │ • 文档│ │ │  │
│  │  │  │   参数      │              │   编码      │              │ • SDK │ │ │  │
│  │  │  │ • 正文      │              │ • 请求头    │              │   生成│ │ │  │
│  │  │  │   (JSON)    │              │   处理      │              │      │ │ │  │
│  │  │  │ • 请求头    │              │             │              │      │ │ │  │
│  │  │  └─────────────┘              └─────────────┘              └──────┘ │ │  │
│  │  │                                                                     │ │  │
│  │  │              由 Pydantic 驱动: 类型驱动验证                       │ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  │                                    │                                     │  │
│  │                                    ▼                                     │  │
│  │  ┌─────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                        端点函数                                    │ │  │
│  │  │                                                                     │ │  │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│ │  │
│  │  │  │    异步     │  │    同步     │  │ WebSocket   │  │后台         ││ │  │
│  │  │  │  函数       │  │  函数       │  │ 端点        │  │   任务      ││ │  │
│  │  │  │             │  │             │  │             │  │             ││ │  │
│  │  │  │ • I/O 密集  │  │ • CPU 密集  │  │ • 实时      │  │ • 异步      ││ │  │
│  │  │  │ • 数据库    │  │ • 计算      │  │   通信      │  │   执行      ││ │  │
│  │  │  │ • 外部      │  │ • 遗留      │  │ • 流式      │  │ • 错误      ││ │  │
│  │  │  │   API       │  │   库        │  │ • 事件      │  │   恢复      ││ │  │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘│ │  │
│  │  └─────────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                       │                                          │
│                                       ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                          存储层                                           │  │
│  │                                                                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │  │
│  │  │  数据库     │  │    缓存     │  │   消息      │  │    文件     │    │  │
│  │  │             │  │             │  │    队列     │  │   存储      │    │  │
│  │  │             │  │             │  │             │  │             │    │  │
│  │  │ • PostgreSQL│  │ • Redis     │  │ • RabbitMQ  │  │ • S3/MinIO  │    │  │
│  │  │ • MongoDB   │  │ • Memcached │  │ • Apache    │  │ • Local FS  │    │  │
│  │  │ • MySQL     │  │ • 内存      │  │   Kafka     │  │ • CDN       │    │  │
│  │  │             │  │   缓存      │  │ • Celery    │  │             │    │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                       │                                          │
│                                       ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                      监控和可观测性                                      │  │
│  │                                                                           │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │  │
│  │  │   指标      │  │   日志      │  │   链路追踪  │  │   健康      │    │  │
│  │  │             │  │             │  │             │  │   检查      │    │  │
│  │  │             │  │             │  │             │  │             │    │  │
│  │  │• Prometheus │  │• 结构化     │  │• Jaeger/    │  │• 存活       │    │  │
│  │  │• Grafana    │  │  JSON 日志  │  │  Zipkin     │  │• 就绪       │    │  │
│  │  │• StatsD     │  │• ELK Stack  │  │• OpenTelem  │  │• 启动       │    │  │
│  │  │• 自定义     │  │• Sentry     │  │• APM        │  │• 自定义     │    │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 2. 组件交互流程

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         组件交互流程                                       │
│                                                                                 │
│    ┌─────────────┐                                                             │
│    │   请求      │                                                             │
│    │   到达      │                                                             │
│    └──────┬──────┘                                                             │
│           │                                                                    │
│           ▼                                                                    │
│    ┌─────────────────────────────────────────────────────────────────────┐   │
│    │                      ASGI 接口                                      │   │
│    │                                                                     │   │
│    │    scope = {                                                        │   │
│    │        'type': 'http',                                              │   │
│    │        'method': 'POST',                                            │   │
│    │        'path': '/api/v1/users',                                     │   │
│    │        'headers': [('content-type', 'application/json')],           │   │
│    │        'query_string': b'',                                         │   │
│    │    }                                                                │   │
│    └─────────────────────────────┬───────────────────────────────────────┘   │
│                                  │                                           │
│                                  ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────┐   │
│    │                   中间件链                                        │   │
│    │                                                                     │   │
│    │  请求    ──► 中间件_1   ──► 中间件_2   ──► ... ──► 端点       │   │
│    │                     │              │                      │         │   │
│    │  响应     ◄── 中间件_1   ◄── 中间件_2   ◄── ... ◄── 响应      │   │
│    │                                                                     │   │
│    │  每个中间件都可以:                                              │   │
│    │  • 修改请求                                                     │   │
│    │  • 短路 (返回早期响应)                                       │   │
│    │  • 添加响应头                                                 │   │
│    │  • 处理异常                                                   │   │
│    └─────────────────────────────┬───────────────────────────────────────┘   │
│                                  │                                           │
│                                  ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────┐   │
│    │                    路由匹配                                         │   │
│    │                                                                     │   │
│    │    routes = [                                                       │   │
│    │        Route("/api/v1/users", UserHandler),                         │   │
│    │        Route("/api/v1/users/{user_id}", UserByIdHandler),           │   │
│    │    ]                                                                │   │
│    │                                                                     │   │
│    │    for route in routes:                                             │   │
│    │        match = route.pattern.match(request.path)                    │   │
│    │        if match and request.method in route.methods:                │   │
│    │            return route.handler                                     │   │
│    └─────────────────────────────┬───────────────────────────────────────┘   │
│                                  │                                           │
│                                  ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────┐   │
│    │                  依赖解析                                        │   │
│    │                                                                     │   │
│    │    async def endpoint(                                              │   │
│    │        user_data: UserCreate,           # ← 正文参数            │   │
│    │        db: Session = Depends(get_db),   # ← 依赖项               │   │
│    │        current_user: User = Depends(   # ← 嵌套依赖          │   │
│    │            get_current_user             #   (依赖于 get_db)       │   │
│    │        )                                                            │   │
│    │    ):                                                               │   │
│    │                                                                     │   │
│    │    解析顺序:                                                    │   │
│    │    1. get_db() → Session                                            │   │
│    │    2. get_current_user(db=Session) → User                           │   │
│    │    3. 解析请求正文 → UserCreate                               │   │
│    │    4. 调用 endpoint(user_data, db, current_user)                    │   │
│    └─────────────────────────────┬───────────────────────────────────────┘   │
│                                  │                                           │
│                                  ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────┐   │
│    │                   请求验证                                      │   │
│    │                                                                     │   │
│    │    class UserCreate(BaseModel):                                     │   │
│    │        name: str = Field(..., min_length=2, max_length=50)          │   │
│    │        email: EmailStr                                              │   │
│    │        age: int = Field(..., ge=18, le=120)                         │   │
│    │                                                                     │   │
│    │    # Pydantic 验证过程:                                         │   │
│    │    1. 解析 JSON 正文                                             │   │
│    │    2. 类型强制 (str → int, 等)                                 │   │
│    │    3. 字段验证 (长度、格式等)                             │   │
│    │    4. 自定义验证器                                           │   │
│    │    5. 创建验证模型实例                                       │   │
│    └─────────────────────────────┬───────────────────────────────────────┘   │
│                                  │                                           │
│                                  ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────┐   │
│    │                  函数执行                                       │   │
│    │                                                                     │   │
│    │    async def create_user(                                           │   │
│    │        user_data: UserCreate,                                       │   │
│    │        db: Session,                                                 │   │
│    │        current_user: User                                           │   │
│    │    ) -> UserResponse:                                               │   │
│    │        # 业务逻辑                                               │   │
│    │        new_user = User(                                             │   │
│    │            name=user_data.name,                                     │   │
│    │            email=user_data.email,                                   │   │
│    │            age=user_data.age                                        │   │
│    │        )                                                            │   │
│    │        db.add(new_user)                                             │   │
│    │        db.commit()                                                  │   │
│    │        return UserResponse.from_orm(new_user)                       │   │
│    └─────────────────────────────┬───────────────────────────────────────┘   │
│                                  │                                           │
│                                  ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────┐   │
│    │                 响应处理                                       │   │
│    │                                                                     │   │
│    │    class UserResponse(BaseModel):                                   │   │
│    │        id: int                                                      │   │
│    │        name: str                                                    │   │
│    │        email: str                                                   │   │
│    │        created_at: datetime                                         │   │
│    │                                                                     │   │
│    │    # 响应处理:                                                 │   │
│    │    1. 验证响应模型                                           │   │
│    │    2. 序列化为 JSON                                            │   │
│    │    3. 设置适当的请求头                                     │   │
│    │    4. 返回 HTTP 响应                                           │   │
│    └─────────────────────────────┬───────────────────────────────────────┘   │
│                                  │                                           │
│                                  ▼                                           │
│    ┌─────────────────────────────────────────────────────────────────────┐   │
│    │                     响应                                            │   │
│    │                                                                     │   │
│    │    HTTP/1.1 201 Created                                            │   │
│    │    Content-Type: application/json                                  │   │
│    │    Content-Length: 156                                             │   │
│    │                                                                     │   │
│    │    {                                                                │   │
│    │        "id": 123,                                                   │   │
│    │        "name": "John Doe",                                          │   │
│    │        "email": "john@example.com",                                 │   │
│    │        "created_at": "2023-12-07T10:30:00Z"                        │   │
│    │    }                                                                │   │
│    └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 3. 各层性能特征

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      各层性能特征                                       │
│                                                                                 │
│  层级                          │ 延迟         │ 吞吐量       │ 扩展性           │
│  ────────────────────────────┼──────────────┼──────────────┼─────────────────│
│                               │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │     负载均衡器         │  │  < 1ms       │ 100K+ req/s  │ 水平            │
│  │    (Nginx/HAProxy)      │  │              │              │ (添加节点)        │
│  └─────────────────────────┘  │              │              │                 │
│              │                │              │              │                 │
│              ▼                │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │     ASGI 服务器        │  │  0.1-0.5ms   │ 60K+ req/s   │ 进程/线程       │
│  │   (Uvicorn/Gunicorn)    │  │              │ 每实例       │ 扩展              │
│  └─────────────────────────┘  │              │              │                 │
│              │                │              │              │                 │
│              ▼                │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │    中间件堆栈          │  │  0.1-2ms     │ 50K+ req/s   │ 优化              │
│  │   (认证、CORS 等)     │  │ (每层)       │              │ 管道              │
│  └─────────────────────────┘  │              │              │                 │
│              │                │              │              │                 │
│              ▼                │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │    路由解析            │  │  0.1-0.5ms   │ 高           │ O(log n) 使用   │
│  │   (路径匹配)            │  │ O(log n)     │              │ 编译正则表达式  │
│  └─────────────────────────┘  │              │              │                 │
│              │                │              │              │                 │
│              ▼                │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │  依赖解析              │  │  0.1ms (缓存) │ 高        │ 多层级           │
│  │   (DI 容器)            │  │  1-5ms (新)  │              │ 缓存              │
│  └─────────────────────────┘  │              │              │                 │
│              │                │              │              │                 │
│              ▼                │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │   请求验证             │  │  0.5-2ms     │ 40K+ req/s   │ 并行              │
│  │   (Pydantic 模型)      │  │ O(字段)     │              │ 验证              │
│  └─────────────────────────┘  │              │              │                 │
│              │                │              │              │                 │
│              ▼                │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │   业务逻辑             │  │  可变        │ 可变         │ 异步优先           │
│  │   (用户端点)           │  │ (用户代码)   │ (用户代码)   │ 设计              │
│  └─────────────────────────┘  │              │              │                 │
│              │                │              │              │                 │
│              ▼                │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │  响应序列化           │  │  0.1-1ms     │ 45K+ req/s   │ orjson          │
│  │   (JSON 编码)          │  │ O(响应      │              │ 优化              │
│  │                         │  │   大小)      │              │                 │
│  └─────────────────────────┘  │              │              │                 │
│              │                │              │              │                 │
│              ▼                │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │    数据库层            │  │  1-100ms     │ 1K-10K 操作/s │ 连接              │
│  │   (PostgreSQL/MongoDB)  │  │ (取决于     │ (取决于     │ 连接池 +         │
│  │                         │  │  查询)       │  硬件)      │ 查询优化         │
│  └─────────────────────────┘  │              │              │                 │
│              │                │              │              │                 │
│              ▼                │              │              │                 │
│  ┌─────────────────────────┐  │              │              │                 │
│  │     缓存层             │  │  0.1-10ms    │ 10K-100K     │ 分布式           │
│  │    (Redis/Memcached)    │  │ (网络 +     │ 操作/s       │ + 一致性         │
│  │                         │  │  序列化/反序列化) │              │ 哈希              │
│  └─────────────────────────┘  │              │              │                 │
│                               │              │              │                 │
│  ────────────────────────────┼──────────────┼──────────────┼─────────────────│
│                               │              │              │                 │
│  总请求延迟:                │              │              │                 │
│  • 简单 (缓存):         1-5ms │              │              │                 │
│  • 复杂 (使用数据库): 10-50ms│              │              │                 │  
│  • 重计算: 100ms+            │              │              │                 │
│                               │              │              │                 │
│  典型吞吐量:                   │              │              │                 │
│  • 简单端点: 60K+ req/s                    │              │                 │
│  • 数据库操作:     5-15K req/s               │              │                 │
│  • 复杂逻辑:    1-5K req/s                      │              │                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

## 4. 部署架构模式

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        部署架构模式                                      │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                          单实例                                        │  │
│  │                       (开发/小规模)                               │  │
│  │                                                                           │  │
│  │    ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │    │                      Docker 容器                               │   │  │
│  │    │                                                                 │   │  │
│  │    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │   │  │
│  │    │  │   FastAPI   │  │  PostgreSQL │  │    Redis    │           │   │  │
│  │    │  │ 应用程序     │  │  数据库     │  │    缓存     │           │   │  │
│  │    │  │             │  │             │  │             │           │   │  │
│  │    │  │ Port: 8000  │  │ Port: 5432  │  │ Port: 6379  │           │   │  │
│  │    │  └─────────────┘  └─────────────┘  └─────────────┘           │   │  │
│  │    └─────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                           │  │
│  │    特征:                                                              │  │
│  │    • 简单部署               • 资源限制                             │  │
│  │    • 容易开发               • 单点故障                             │  │  
│  │    • 快速设置               • 不可水平扩展                         │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         多实例                                       │  │
│  │                      (生产/中等规模)                                │  │
│  │                                                                           │  │
│  │    ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │    │                      负载均衡器                                │   │  │
│  │    │                     (Nginx/HAProxy)                            │   │  │
│  │    └─────────────────┬─────────────────┬─────────────────────────────┘   │  │
│  │                      │                 │                                 │  │
│  │    ┌─────────────────▼─────┐  ┌────────▼─────────┐  ┌─────────────────┐ │  │
│  │    │   FastAPI Instance    │  │  FastAPI Instance │  │  FastAPI Instance│ │  │
│  │    │         #1            │  │         #2        │  │         #N      │ │  │
│  │    │                       │  │                   │  │                 │ │  │
│  │    │ • Auto-scaling        │  │ • Health checks   │  │ • Rolling       │ │  │
│  │    │ • Session affinity    │  │ • Circuit breaker │  │   deployments   │ │  │
│  │    └───────────────────────┘  └───────────────────┘  └─────────────────┘ │  │
│  │                      │                 │                 │               │  │
│  │                      └─────────────────┼─────────────────┘               │  │
│  │                                        │                                 │  │
│  │    ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │    │                    Shared Services                             │   │  │
│  │    │                                                                 │   │  │
│  │    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │   │  │
│  │    │  │ PostgreSQL  │  │    Redis    │  │   Message   │           │   │  │
│  │    │  │   Cluster   │  │   Cluster   │  │    Queue    │           │   │  │
│  │    │  │             │  │             │  │  (RabbitMQ) │           │   │  │
│  │    │  │ • Master/   │  │ • Sentinel  │  │             │           │   │  │
│  │    │  │   Replica   │  │ • Sharding  │  │ • Task      │           │   │  │
│  │    │  │ • Auto-     │  │ • Failover  │  │   queues    │           │   │  │
│  │    │  │   failover  │  │             │  │ • Dead      │           │   │  │
│  │    │  │             │  │             │  │   letters   │           │   │  │
│  │    │  └─────────────┘  └─────────────┘  └─────────────┘           │   │  │
│  │    └─────────────────────────────────────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         Microservices                                     │  │
│  │                      (Enterprise/Large Scale)                             │  │
│  │                                                                           │  │
│  │    ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │    │                      API Gateway                               │   │  │
│  │    │              (Kong/AWS API Gateway)                            │   │  │
│  │    │                                                                 │   │  │
│  │    │ • Rate limiting     • Authentication    • Request routing      │   │  │
│  │    │ • Load balancing    • SSL termination  • Response caching     │   │  │
│  │    └─────────────────┬─────────────────┬─────────────────────────────┘   │  │
│  │                      │                 │                                 │  │
│  │    ┌─────────────────▼─────┐  ┌────────▼─────────┐  ┌─────────────────┐ │  │
│  │    │   User Service        │  │  Product Service │  │  Order Service  │ │  │
│  │    │                       │  │                  │  │                 │ │  │
│  │    │ • FastAPI app         │  │ • FastAPI app    │  │ • FastAPI app   │ │  │
│  │    │ • User auth           │  │ • Catalog mgmt   │  │ • Order proc    │ │  │
│  │    │ • Profile mgmt        │  │ • Inventory      │  │ • Payment       │ │  │
│  │    │                       │  │                  │  │                 │ │  │
│  │    │ ┌─────────────────┐   │  │ ┌──────────────┐ │  │ ┌─────────────┐ │ │  │
│  │    │ │   PostgreSQL    │   │  │ │  PostgreSQL  │ │  │ │ PostgreSQL  │ │ │  │
│  │    │ │   (Users DB)    │   │  │ │ (Products DB)│ │  │ │ (Orders DB) │ │ │  │
│  │    │ └─────────────────┘   │  │ └──────────────┘ │  │ └─────────────┘ │ │  │
│  │    └───────────────────────┘  └──────────────────┘  └─────────────────┘ │  │
│  │                      │                 │                 │               │  │
│  │                      └─────────────────┼─────────────────┘               │  │
│  │                                        │                                 │  │
│  │    ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │    │                 Shared Infrastructure                          │   │  │
│  │    │                                                                 │   │  │
│  │    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │   │  │
│  │    │  │ Service     │  │   Message   │  │    Shared   │           │   │  │
│  │    │  │ Discovery   │  │     Bus     │  │    Cache    │           │   │  │
│  │    │  │             │  │             │  │             │           │   │  │
│  │    │  │ • Consul    │  │ • Apache    │  │ • Redis     │           │   │  │
│  │    │  │ • Eureka    │  │   Kafka     │  │   Cluster   │           │   │  │
│  │    │  │ • K8s DNS   │  │ • RabbitMQ  │  │ • Memcached │           │   │  │
│  │    │  │             │  │ • NATS      │  │             │           │   │  │
│  │    │  └─────────────┘  └─────────────┘  └─────────────┘           │   │  │
│  │    └─────────────────────────────────────────────────────────────────┘   │  │
│  │                                                                           │  │
│  │    ┌─────────────────────────────────────────────────────────────────┐   │  │
│  │    │                  Observability Stack                           │   │  │
│  │    │                                                                 │   │  │
│  │    │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │   │  │
│  │    │  │   Metrics   │  │   Logging   │  │   Tracing   │           │   │  │
│  │    │  │             │  │             │  │             │           │   │  │
│  │    │  │ • Prometheus│  │ • ELK Stack │  │ • Jaeger    │           │   │  │
│  │    │  │ • Grafana   │  │ • Fluentd   │  │ • Zipkin    │           │   │  │
│  │    │  │ • AlertMgr  │  │ • Logstash  │  │ • OpenTel   │           │   │  │
│  │    │  └─────────────┘  └─────────────┘  └─────────────┘           │   │  │
│  │    └─────────────────────────────────────────────────────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                 │
│  扩展特征:                                                               │
│  • 单实例:          100-1K    并发用户                             │
│  • 多实例:         1K-10K    并发用户                             │
│  • 微服务:         10K-100K+ 并发用户                             │
└─────────────────────────────────────────────────────────────────────────────────┘
```