# Flaskä¼šè¯å’Œæ¨¡æ¿ç³»ç»Ÿæ·±åº¦è§£æ

## ğŸ’¾ ä¼šè¯ç®¡ç†çš„å®‰å…¨è®¾è®¡

Flaskçš„ä¼šè¯ç³»ç»Ÿé€šè¿‡å®‰å…¨Cookieå®ç°äº†æ— çŠ¶æ€çš„ä¼šè¯ç®¡ç†ï¼Œä½“ç°äº†Webåº”ç”¨å®‰å…¨è®¾è®¡çš„æœ€ä½³å®è·µã€‚

### æ ¸å¿ƒå®ç°æœºåˆ¶

**SessionMixinçš„å­—å…¸æŠ½è±¡** (`flask/sessions.py:24-49`)ï¼š

```python
class SessionMixin(MutableMapping[str, t.Any]):
    """æ‰©å±•åŸºç¡€å­—å…¸çš„ä¼šè¯å±æ€§"""
    
    @property
    def permanent(self) -> bool:
        """åæ˜ å­—å…¸ä¸­'_permanent'é”®çš„å€¼"""
        return self.get("_permanent", False)

    @permanent.setter
    def permanent(self, value: bool) -> None:
        self["_permanent"] = bool(value)

    # ä¼šè¯çŠ¶æ€è·Ÿè¸ª
    new = False        # æ˜¯å¦æ–°åˆ›å»ºçš„ä¼šè¯
    modified = True    # æ˜¯å¦å·²ä¿®æ”¹
    accessed = True    # æ˜¯å¦å·²è®¿é—®
```

**SecureCookieSessionInterfaceçš„ç­¾åæœºåˆ¶**ï¼š

```python
class SecureCookieSessionInterface(SessionInterface):
    """åŸºäºå®‰å…¨Cookieçš„ä¼šè¯å®ç°"""
    
    def get_signing_serializer(self, app: Flask) -> URLSafeTimedSerializer | None:
        if not app.secret_key:
            return None
        signer_kwargs = dict(
            key_derivation=self.key_derivation,
            digest_method=self.digest_method,
        )
        return URLSafeTimedSerializer(
            app.secret_key,
            salt=self.salt,
            serializer=self.serializer,
            signer_kwargs=signer_kwargs,
        )
    
    def open_session(self, app: Flask, request: Request) -> SecureCookieSession | None:
        s = self.get_signing_serializer(app)
        if s is None:
            return None
        val = request.cookies.get(self.get_cookie_name(app))
        if not val:
            return self.session_class()
        max_age = int(app.permanent_session_lifetime.total_seconds())
        try:
            data = s.loads(val, max_age=max_age)
            return self.session_class(data)
        except BadSignature:
            return self.session_class()
```

### å®‰å…¨è®¾è®¡è¦ç‚¹

#### 1. ç­¾åéªŒè¯æœºåˆ¶

**ä½¿ç”¨itsdangerousè¿›è¡Œæ¶ˆæ¯è®¤è¯**ï¼š
```python
from itsdangerous import URLSafeTimedSerializer, BadSignature

# Flaskä¼šè¯ç­¾åçš„æ ¸å¿ƒ
def secure_session_example():
    serializer = URLSafeTimedSerializer(
        secret_key="your-secret-key",
        salt="cookie-session",  # é˜²æ­¢ä¸åŒç”¨é€”çš„ç­¾åæ··æ·†
    )
    
    # åºåˆ—åŒ–ä¼šè¯æ•°æ®
    session_data = {"user_id": 123, "username": "alice"}
    signed_value = serializer.dumps(session_data)
    
    # éªŒè¯å’Œååºåˆ—åŒ–
    try:
        # max_ageå‚æ•°å®ç°è¿‡æœŸæ—¶é—´æ£€æŸ¥
        original_data = serializer.loads(signed_value, max_age=3600)
        print(f"Valid session: {original_data}")
    except BadSignature:
        print("Invalid or tampered session!")
```

#### 2. æ—¶é—´æˆ³éªŒè¯

**ä¼šè¯è¿‡æœŸæ§åˆ¶**ï¼š
```python
def session_expiry_control():
    # æ°¸ä¹…ä¼šè¯çš„æ—¶é—´æ§åˆ¶
    app.permanent_session_lifetime = timedelta(days=31)
    
    # åœ¨è§†å›¾ä¸­è®¾ç½®ä¼šè¯æŒä¹…æ€§
    @app.route('/login', methods=['POST'])
    def login():
        if verify_credentials(request.form['username'], request.form['password']):
            session['user_id'] = get_user_id(request.form['username'])
            session.permanent = True  # è®¾ç½®ä¸ºæ°¸ä¹…ä¼šè¯
            return redirect('/dashboard')
        return 'Invalid credentials'
```

#### 3. å¯†é’¥æ´¾ç”Ÿå’Œç›å€¼éš”ç¦»

**å¤šå±‚å®‰å…¨æœºåˆ¶**ï¼š
```python
class SecureCookieSessionInterface(SessionInterface):
    # å¯†é’¥æ´¾ç”Ÿæ–¹æ³•
    key_derivation = "hmac"
    
    # æ‘˜è¦æ–¹æ³•
    digest_method = staticmethod(hashlib.sha1)
    
    # ç›å€¼é˜²æ­¢ç­¾åé‡ç”¨
    salt = "cookie-session"
    
    def get_signing_serializer(self, app: Flask):
        # ä½¿ç”¨HMACè¿›è¡Œå¯†é’¥æ´¾ç”Ÿ
        signer_kwargs = dict(
            key_derivation=self.key_derivation,  # 'hmac'
            digest_method=self.digest_method,    # sha1
        )
        return URLSafeTimedSerializer(
            app.secret_key,
            salt=self.salt,  # é˜²æ­¢ä¸åŒç”¨é€”çš„ç­¾åæ··æ·†
            signer_kwargs=signer_kwargs,
        )
```

### ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

#### 1. ä¼šè¯çš„æ‰“å¼€è¿‡ç¨‹

**RequestContextä¸­çš„ä¼šè¯åˆå§‹åŒ–**ï¼š
```python
def push(self) -> None:
    # ... åº”ç”¨ä¸Šä¸‹æ–‡å¤„ç† ...
    
    # ä¼šè¯ç®¡ç†
    if self.session is None:
        session_interface = self.app.session_interface
        self.session = session_interface.open_session(self.app, self.request)
        if self.session is None:
            self.session = session_interface.make_null_session(self.app)
```

**ç©ºä¼šè¯çš„ä¼˜é›…å¤„ç†**ï¼š
```python
def make_null_session(self, app: Flask) -> NullSession:
    """åˆ›å»ºç©ºä¼šè¯ï¼Œå½“æ— æ³•åˆ›å»ºæ­£å¸¸ä¼šè¯æ—¶ä½¿ç”¨"""
    return self.null_session_class()

class NullSession(SecureCookieSession):
    """åªè¯»çš„ç©ºä¼šè¯ï¼Œé˜²æ­¢åœ¨æ— å¯†é’¥æ—¶å‡ºé”™"""
    
    def _fail(self, *args, **kwargs):
        raise RuntimeError(
            "The session is unavailable because no secret key was set. "
            "Set the secret_key on the application to something unique and secret."
        )
    
    __setitem__ = __delitem__ = clear = pop = popitem = update = setdefault = _fail
    del _fail
```

#### 2. ä¼šè¯çš„ä¿å­˜è¿‡ç¨‹

**å“åº”å¤„ç†ä¸­çš„ä¼šè¯ä¿å­˜**ï¼š
```python
def save_session(self, app: Flask, session: SessionMixin, response: Response) -> None:
    if not self.should_set_cookie(app, session):
        return
    
    # Cookieå®‰å…¨å±æ€§è®¾ç½®
    httponly = self.get_cookie_httponly(app)  # é˜²æ­¢XSS
    secure = self.get_cookie_secure(app)      # HTTPS only
    samesite = self.get_cookie_samesite(app)  # CSRFé˜²æŠ¤
    expires = self.get_expiration_time(app, session)
    
    # åºåˆ—åŒ–å’Œç­¾å
    val = self.get_signing_serializer(app).dumps(dict(session))
    
    response.set_cookie(
        self.get_cookie_name(app),
        val,
        expires=expires,
        httponly=httponly,
        domain=self.get_cookie_domain(app),
        path=self.get_cookie_path(app),
        secure=secure,
        samesite=samesite,
    )
```

#### 3. Cookieå®‰å…¨å±æ€§è¯¦è§£

**å¤šå±‚å®‰å…¨é˜²æŠ¤**ï¼š
```python
def configure_session_security(app):
    # HttpOnly: é˜²æ­¢JavaScriptè®¿é—®cookie
    app.config['SESSION_COOKIE_HTTPONLY'] = True
    
    # Secure: åªåœ¨HTTPSè¿æ¥ä¸­å‘é€
    app.config['SESSION_COOKIE_SECURE'] = True
    
    # SameSite: CSRFæ”»å‡»é˜²æŠ¤
    app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'  # æˆ– 'Strict'
    
    # Domain: é™åˆ¶cookieçš„åŸŸèŒƒå›´
    app.config['SESSION_COOKIE_DOMAIN'] = '.example.com'
    
    # Path: é™åˆ¶cookieçš„è·¯å¾„èŒƒå›´
    app.config['SESSION_COOKIE_PATH'] = '/app'
    
    # Name: è‡ªå®šä¹‰cookieåç§°
    app.config['SESSION_COOKIE_NAME'] = 'my_session'
```

---

## ğŸ¨ æ¨¡æ¿ç³»ç»Ÿçš„ä¸Šä¸‹æ–‡é›†æˆ

Flaskçš„æ¨¡æ¿ç³»ç»Ÿé€šè¿‡æ·±åº¦é›†æˆJinja2ï¼Œå®ç°äº†ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„æ¨¡æ¿æ¸²æŸ“æœºåˆ¶ã€‚

### Jinja2ç¯å¢ƒçš„Flaskå®šåˆ¶

**Environmentç±»çš„è“å›¾æ„ŸçŸ¥** (`flask/templating.py:39-50`)ï¼š

```python
class Environment(BaseEnvironment):
    """Flaskæ„ŸçŸ¥çš„Jinja2ç¯å¢ƒ"""
    
    def __init__(self, app: App, **options: t.Any) -> None:
        if "loader" not in options:
            options["loader"] = app.create_global_jinja_loader()
        BaseEnvironment.__init__(self, **options)
        self.app = app
```

**å…¨å±€JinjaåŠ è½½å™¨çš„åˆ›å»º**ï¼š
```python
def create_global_jinja_loader(self) -> BaseLoader:
    """åˆ›å»ºå…¨å±€æ¨¡æ¿åŠ è½½å™¨ï¼Œæ”¯æŒè“å›¾æ¨¡æ¿"""
    return ChoiceLoader([
        self.jinja_loader,  # åº”ç”¨æ¨¡æ¿
        PrefixLoader({
            name: blueprint.jinja_loader
            for name, blueprint in self.blueprints.items()
            if blueprint.jinja_loader is not None
        })  # è“å›¾æ¨¡æ¿
    ])
```

### é»˜è®¤æ¨¡æ¿ä¸Šä¸‹æ–‡å¤„ç†å™¨

**è‡ªåŠ¨æ³¨å…¥Flaskå¯¹è±¡** (`flask/templating.py:24-36`)ï¼š

```python
def _default_template_ctx_processor() -> dict[str, t.Any]:
    """é»˜è®¤æ¨¡æ¿ä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼Œæ³¨å…¥requestã€sessionå’Œg"""
    appctx = _cv_app.get(None)
    reqctx = _cv_request.get(None)
    rv: dict[str, t.Any] = {}
    if appctx is not None:
        rv["g"] = appctx.g
    if reqctx is not None:
        rv["request"] = reqctx.request
        rv["session"] = reqctx.session
    return rv
```

**æ¨¡æ¿ä¸­çš„Flaskå¯¹è±¡ä½¿ç”¨**ï¼š
```html
<!-- åœ¨æ¨¡æ¿ä¸­ç›´æ¥ä½¿ç”¨Flaskå¯¹è±¡ -->
<h1>Welcome to {{ g.site_name }}</h1>
<p>Current user: {{ session.get('username', 'Guest') }}</p>
<p>Request path: {{ request.path }}</p>
<p>Request method: {{ request.method }}</p>

<!-- æ¡ä»¶æ¸²æŸ“åŸºäºè¯·æ±‚ä¿¡æ¯ -->
{% if request.endpoint == 'user.profile' %}
    <div class="profile-specific-content">...</div>
{% endif %}

<!-- åŸºäºä¼šè¯çŠ¶æ€çš„æ¡ä»¶æ¸²æŸ“ -->
{% if session.get('user_id') %}
    <nav class="authenticated-nav">...</nav>
{% else %}
    <nav class="guest-nav">...</nav>
{% endif %}
```

### æ¨¡æ¿æ¸²æŸ“çš„ä¿¡å·é›†æˆ

**render_templateå‡½æ•°çš„å®Œæ•´å®ç°**ï¼š

```python
def render_template(template_name_or_list: str | Template | list[str | Template], **context: t.Any) -> str:
    """æ¸²æŸ“æ¨¡æ¿å¹¶è¿”å›å­—ç¬¦ä¸²"""
    app = current_app._get_current_object()
    
    # è·å–æ¨¡æ¿å¯¹è±¡
    if isinstance(template_name_or_list, (str, Template)):
        template = app.jinja_env.get_template(template_name_or_list)
    else:
        template = app.jinja_env.select_template(template_name_or_list)
    
    # æ„å»ºæ¨¡æ¿ä¸Šä¸‹æ–‡
    context = app.update_template_context(context)
    
    # å‘é€æ¸²æŸ“å‰ä¿¡å·
    before_render_template.send(
        app, 
        template=template, 
        context=context,
        _async_wrapper=app.ensure_sync
    )
    
    # æ‰§è¡Œæ¸²æŸ“
    rv = template.render(context)
    
    # å‘é€æ¸²æŸ“åä¿¡å·
    template_rendered.send(
        app,
        template=template,
        context=context,
        _async_wrapper=app.ensure_sync
    )
    
    return rv
```

### æ¨¡æ¿ä¸Šä¸‹æ–‡çš„å±‚æ¬¡åŒ–æ„å»º

**å¤šå±‚ä¸Šä¸‹æ–‡å¤„ç†å™¨**ï¼š
```python
def update_template_context(self, context: dict[str, t.Any]) -> dict[str, t.Any]:
    """æ›´æ–°æ¨¡æ¿ä¸Šä¸‹æ–‡ï¼Œæ”¯æŒåº”ç”¨çº§å’Œè“å›¾çº§å¤„ç†å™¨"""
    funcs = self.template_context_processors[None]  # åº”ç”¨çº§å¤„ç†å™¨
    
    # æ”¶é›†å½“å‰è“å›¾é“¾ä¸Šçš„æ‰€æœ‰å¤„ç†å™¨
    for bp in self.iter_blueprints():
        funcs.extend(self.template_context_processors.get(bp.name, ()))
    
    orig_ctx = context.copy()
    
    # æ‰§è¡Œæ‰€æœ‰ä¸Šä¸‹æ–‡å¤„ç†å™¨
    for func in funcs:
        context.update(func())
    
    # ç¡®ä¿åŸå§‹ä¸Šä¸‹æ–‡ä¼˜å…ˆçº§æœ€é«˜
    context.update(orig_ctx)
    
    return context
```

**è‡ªå®šä¹‰æ¨¡æ¿ä¸Šä¸‹æ–‡å¤„ç†å™¨**ï¼š
```python
@app.context_processor
def inject_global_vars():
    """å…¨å±€æ¨¡æ¿å˜é‡æ³¨å…¥"""
    return {
        'site_name': app.config['SITE_NAME'],
        'current_year': datetime.now().year,
        'debug_mode': app.debug,
    }

@app.context_processor  
def inject_user_info():
    """ç”¨æˆ·ä¿¡æ¯æ³¨å…¥"""
    if 'user_id' in session:
        user = get_user(session['user_id'])
        return {'current_user': user}
    return {'current_user': None}

# è“å›¾çº§ä¸Šä¸‹æ–‡å¤„ç†å™¨
@blog_bp.app_context_processor
def inject_blog_vars():
    """åšå®¢è“å›¾ä¸“ç”¨å˜é‡"""
    return {
        'blog_title': 'My Blog',
        'recent_posts': get_recent_posts(5),
    }
```

### æ¨¡æ¿ç»§æ‰¿å’ŒåŒ…å«æœºåˆ¶

#### 1. æ¨¡æ¿ç»§æ‰¿çš„Flaskæ‰©å±•

**åŸºç¡€æ¨¡æ¿ç»“æ„**ï¼š
```html
<!-- base.html -->
<!DOCTYPE html>
<html>
<head>
    <title>{% block title %}{{ g.site_name }}{% endblock %}</title>
    {% block head %}{% endblock %}
</head>
<body>
    {% if session.get('user_id') %}
        {% include 'navigation.html' %}
    {% endif %}
    
    <main>
        {% block content %}{% endblock %}
    </main>
    
    {% block scripts %}{% endblock %}
</body>
</html>
```

**å­æ¨¡æ¿ç»§æ‰¿**ï¼š
```html
<!-- user/profile.html -->
{% extends "base.html" %}

{% block title %}Profile - {{ super() }}{% endblock %}

{% block content %}
<h1>{{ current_user.username }}'s Profile</h1>
<p>Last login: {{ request.headers.get('X-Last-Login', 'Never') }}</p>

{% if request.method == 'POST' %}
    <div class="alert alert-success">Profile updated!</div>
{% endif %}
{% endblock %}
```

#### 2. åŠ¨æ€æ¨¡æ¿é€‰æ‹©

**åŸºäºä¸Šä¸‹æ–‡çš„æ¨¡æ¿é€‰æ‹©**ï¼š
```python
@app.route('/dashboard')
def dashboard():
    user_role = session.get('role', 'guest')
    
    # æ ¹æ®ç”¨æˆ·è§’è‰²é€‰æ‹©ä¸åŒæ¨¡æ¿
    template_choices = [
        f'dashboard/{user_role}.html',
        'dashboard/default.html'
    ]
    
    return render_template(template_choices, user_data=get_user_data())
```

### æ¨¡æ¿è¿‡æ»¤å™¨å’Œå‡½æ•°æ‰©å±•

#### 1. è‡ªå®šä¹‰è¿‡æ»¤å™¨

**Flaskä¸­çš„è¿‡æ»¤å™¨æ³¨å†Œ**ï¼š
```python
@app.template_filter('datetime')
def datetime_filter(value, format='%Y-%m-%d %H:%M'):
    """æ—¥æœŸæ—¶é—´æ ¼å¼åŒ–è¿‡æ»¤å™¨"""
    if isinstance(value, str):
        value = datetime.fromisoformat(value)
    return value.strftime(format)

@app.template_filter('truncate_words')
def truncate_words_filter(text, length=50):
    """å•è¯æˆªæ–­è¿‡æ»¤å™¨"""
    words = text.split()
    if len(words) <= length:
        return text
    return ' '.join(words[:length]) + '...'

# åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨
# {{ post.created_at | datetime('%m/%d/%Y') }}
# {{ post.content | truncate_words(20) }}
```

#### 2. å…¨å±€æ¨¡æ¿å‡½æ•°

**æ³¨å†Œå…¨å±€å‡½æ•°**ï¼š
```python
@app.template_global()
def url_for_other_page(page):
    """åˆ†é¡µURLç”Ÿæˆå‡½æ•°"""
    args = request.view_args.copy()
    args['page'] = page
    return url_for(request.endpoint, **args)

@app.template_global()
def get_flashed_messages_by_category():
    """æŒ‰ç±»åˆ«è·å–flashæ¶ˆæ¯"""
    messages = get_flashed_messages(with_categories=True)
    categorized = {}
    for category, message in messages:
        categorized.setdefault(category, []).append(message)
    return categorized

# åœ¨æ¨¡æ¿ä¸­ä½¿ç”¨
# <a href="{{ url_for_other_page(page + 1) }}">Next</a>
# {% for category, messages in get_flashed_messages_by_category().items() %}
```

### è“å›¾æ¨¡æ¿å‘½åç©ºé—´

#### 1. è“å›¾æ¨¡æ¿éš”ç¦»

**è“å›¾æ¨¡æ¿ç»„ç»‡**ï¼š
```
project/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ templates/
â”‚   â”‚   â”œâ”€â”€ base.html
â”‚   â”‚   â””â”€â”€ index.html
â”‚   â””â”€â”€ blueprints/
â”‚       â”œâ”€â”€ blog/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ templates/
â”‚       â”‚       â””â”€â”€ blog/
â”‚       â”‚           â”œâ”€â”€ index.html
â”‚       â”‚           â””â”€â”€ post.html
â”‚       â””â”€â”€ user/
â”‚           â”œâ”€â”€ __init__.py
â”‚           â””â”€â”€ templates/
â”‚               â””â”€â”€ user/
â”‚                   â”œâ”€â”€ profile.html
â”‚                   â””â”€â”€ login.html
```

**è“å›¾ä¸­çš„æ¨¡æ¿æ¸²æŸ“**ï¼š
```python
# blogè“å›¾
@blog_bp.route('/')
def index():
    # æ¸²æŸ“blog/index.html
    return render_template('blog/index.html', posts=get_posts())

@blog_bp.route('/post/<int:id>')
def post(id):
    # æ¸²æŸ“blog/post.html
    return render_template('blog/post.html', post=get_post(id))
```

#### 2. æ¨¡æ¿åç§°è§£æ

**è“å›¾æ¨¡æ¿çš„æŸ¥æ‰¾é¡ºåº**ï¼š
```python
# å½“åœ¨è“å›¾ä¸­è°ƒç”¨render_template('blog/index.html')æ—¶ï¼š
# 1. é¦–å…ˆæŸ¥æ‰¾åº”ç”¨æ¨¡æ¿ç›®å½•ä¸­çš„blog/index.html
# 2. ç„¶åæŸ¥æ‰¾è“å›¾æ¨¡æ¿ç›®å½•ä¸­çš„blog/index.html
# 3. å¦‚æœéƒ½æ²¡æ‰¾åˆ°ï¼ŒæŠ›å‡ºTemplateNotFoundå¼‚å¸¸

def create_global_jinja_loader(self) -> BaseLoader:
    """åˆ›å»ºæ”¯æŒè“å›¾çš„æ¨¡æ¿åŠ è½½å™¨"""
    return ChoiceLoader([
        self.jinja_loader,  # åº”ç”¨æ¨¡æ¿ä¼˜å…ˆ
        PrefixLoader({      # è“å›¾æ¨¡æ¿å…¶æ¬¡
            name: blueprint.jinja_loader
            for name, blueprint in self.blueprints.items()
            if blueprint.jinja_loader is not None
        })
    ])
```

### æ¨¡æ¿å®‰å…¨æœºåˆ¶

#### 1. è‡ªåŠ¨è½¬ä¹‰

**XSSé˜²æŠ¤çš„è‡ªåŠ¨è½¬ä¹‰**ï¼š
```python
# Flaské»˜è®¤å¯ç”¨è‡ªåŠ¨è½¬ä¹‰
app = Flask(__name__)
assert app.jinja_env.autoescape == True

# åœ¨æ¨¡æ¿ä¸­ï¼Œæ‰€æœ‰å˜é‡éƒ½ä¼šè‡ªåŠ¨è½¬ä¹‰
# {{ user_input }}  # è‡ªåŠ¨è½¬ä¹‰HTMLå­—ç¬¦

# æ‰‹åŠ¨æ§åˆ¶è½¬ä¹‰
# {{ user_input | safe }}      # æ ‡è®°ä¸ºå®‰å…¨ï¼Œä¸è½¬ä¹‰
# {{ user_input | escape }}    # å¼ºåˆ¶è½¬ä¹‰
# {% autoescape false %}       # ä¸´æ—¶ç¦ç”¨è‡ªåŠ¨è½¬ä¹‰
#   {{ user_input }}
# {% endautoescape %}
```

#### 2. CSPé›†æˆ

**å†…å®¹å®‰å…¨ç­–ç•¥æ”¯æŒ**ï¼š
```python
@app.after_request
def set_csp_header(response):
    """è®¾ç½®å†…å®¹å®‰å…¨ç­–ç•¥å¤´"""
    if request.endpoint and 'admin' in request.endpoint:
        # ç®¡ç†é¡µé¢æ›´ä¸¥æ ¼çš„CSP
        csp = "default-src 'self'; script-src 'self' 'unsafe-inline'"
    else:
        # æ™®é€šé¡µé¢çš„CSP
        csp = "default-src 'self'; script-src 'self' cdn.example.com"
    
    response.headers['Content-Security-Policy'] = csp
    return response
```

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 1. æ¨¡æ¿ç¼“å­˜

**Jinja2æ¨¡æ¿ç¼–è¯‘ç¼“å­˜**ï¼š
```python
# ç”Ÿäº§ç¯å¢ƒå¯ç”¨å­—èŠ‚ç ç¼“å­˜
import tempfile
from jinja2 import FileSystemBytecodeCache

cache_dir = tempfile.mkdtemp()
app.jinja_env.bytecode_cache = FileSystemBytecodeCache(cache_dir)
```

#### 2. ä¸Šä¸‹æ–‡å¤„ç†å™¨ä¼˜åŒ–

**é¿å…é‡å¤è®¡ç®—**ï¼š
```python
@app.context_processor
def inject_cached_data():
    """ç¼“å­˜æ˜‚è´µçš„ä¸Šä¸‹æ–‡æ•°æ®"""
    # ä½¿ç”¨è¯·æ±‚çº§ç¼“å­˜
    if not hasattr(g, '_cached_nav_items'):
        g._cached_nav_items = get_navigation_items()
    
    return {
        'nav_items': g._cached_nav_items,
        'site_stats': get_cached_site_stats(),
    }
```

### å¯å€Ÿé‰´çš„è®¾è®¡æ¨¡å¼

#### ä¼šè¯ç®¡ç†æ–¹é¢
1. **ç­¾åéªŒè¯æ¨¡å¼**: å®¢æˆ·ç«¯å­˜å‚¨ï¼ŒæœåŠ¡ç«¯éªŒè¯çš„æ— çŠ¶æ€è®¾è®¡
2. **æ—¶é—´æˆ³éªŒè¯**: é˜²æ­¢é‡æ”¾æ”»å‡»çš„æ—¶æ•ˆæ€§æ§åˆ¶
3. **ä¼˜é›…é™çº§**: ç©ºä¼šè¯çš„å®‰å…¨å›é€€æœºåˆ¶
4. **å¤šå±‚å®‰å…¨é˜²æŠ¤**: Cookieå±æ€§çš„å…¨é¢å®‰å…¨é…ç½®

#### æ¨¡æ¿ç³»ç»Ÿæ–¹é¢
1. **ä¸Šä¸‹æ–‡æ³¨å…¥æ¨¡å¼**: è‡ªåŠ¨æ³¨å…¥æ¡†æ¶å¯¹è±¡çš„ä¾¿åˆ©æ€§è®¾è®¡
2. **å±‚æ¬¡åŒ–å¤„ç†å™¨**: åº”ç”¨çº§å’Œè“å›¾çº§çš„åˆ†å±‚å¤„ç†
3. **å‘½åç©ºé—´éš”ç¦»**: è“å›¾æ¨¡æ¿çš„ç‹¬ç«‹æ€§ä¿è¯
4. **ä¿¡å·é›†æˆæ¨¡å¼**: æ¨¡æ¿æ¸²æŸ“è¿‡ç¨‹çš„é’©å­æ‰©å±•

### è®¾è®¡å“²å­¦æ€»ç»“

Flaskçš„ä¼šè¯å’Œæ¨¡æ¿ç³»ç»Ÿä½“ç°äº†ä»¥ä¸‹æ ¸å¿ƒç†å¿µï¼š

1. **å®‰å…¨ä¼˜å…ˆ**: ä¼šè¯ç³»ç»Ÿçš„å¤šå±‚å®‰å…¨æœºåˆ¶è®¾è®¡
2. **ä¾¿åˆ©æ€§å¹³è¡¡**: åœ¨å®‰å…¨æ€§å’Œæ˜“ç”¨æ€§é—´æ‰¾åˆ°æœ€ä½³å¹³è¡¡ç‚¹
3. **æ‰©å±•å‹å¥½**: ä¸°å¯Œçš„é’©å­å’Œå¤„ç†å™¨æ‰©å±•ç‚¹
4. **æ€§èƒ½æ„è¯†**: ç¼“å­˜å’Œä¼˜åŒ–ç­–ç•¥çš„æ·±å…¥è€ƒè™‘
5. **å‘åå…¼å®¹**: æ¸è¿›å¼åŠŸèƒ½å¢å¼ºï¼Œä¿æŒAPIç¨³å®š

è¿™äº›è®¾è®¡æ¨¡å¼åœ¨æ„å»ºå®‰å…¨ã€é«˜æ•ˆçš„Webåº”ç”¨æ—¶å…·æœ‰é‡è¦çš„æŒ‡å¯¼ä»·å€¼ã€‚