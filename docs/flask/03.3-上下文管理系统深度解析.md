# Flaskä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿæ·±åº¦è§£æ

## ğŸ§µ ä¸Šä¸‹æ–‡ç³»ç»Ÿçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

Flaskçš„ä¸Šä¸‹æ–‡ç³»ç»Ÿæ˜¯å…¶æ¶æ„çš„æ ¸å¿ƒï¼Œé€šè¿‡ç²¾å¦™çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å®ç°äº†çŠ¶æ€éš”ç¦»å’Œèµ„æºç®¡ç†ã€‚

### æ ¸å¿ƒå®ç°è§£æ

**AppContextçš„push/popæœºåˆ¶** (`flask/ctx.py:251-272`)ï¼š

```python
class AppContext:
    def __init__(self, app: Flask) -> None:
        self.app = app
        self.url_adapter = app.create_url_adapter(None)
        self.g: _AppCtxGlobals = app.app_ctx_globals_class()
        self._cv_tokens: list[contextvars.Token[AppContext]] = []

    def push(self) -> None:
        """ç»‘å®šåº”ç”¨ä¸Šä¸‹æ–‡åˆ°å½“å‰ä¸Šä¸‹æ–‡"""
        self._cv_tokens.append(_cv_app.set(self))
        appcontext_pushed.send(self.app, _async_wrapper=self.app.ensure_sync)

    def pop(self, exc: BaseException | None = _sentinel) -> None:
        """å¼¹å‡ºåº”ç”¨ä¸Šä¸‹æ–‡"""
        try:
            if len(self._cv_tokens) == 1:
                if exc is _sentinel:
                    exc = sys.exc_info()[1]
                self.app.do_teardown_appcontext(exc)
        finally:
            ctx = _cv_app.get()
            _cv_app.reset(self._cv_tokens.pop())

        if ctx is not self:
            raise AssertionError(f"Popped wrong app context. ({ctx!r} instead of {self!r})")
        appcontext_popped.send(self.app, _async_wrapper=self.app.ensure_sync)
```

### RequestContextçš„æ™ºèƒ½ç®¡ç†

**è‡ªåŠ¨ä¾èµ–ç®¡ç†** (`flask/ctx.py:367-394`)ï¼š

```python
def push(self) -> None:
    # è‡ªåŠ¨ç¡®ä¿åº”ç”¨ä¸Šä¸‹æ–‡å­˜åœ¨
    app_ctx = _cv_app.get(None)
    if app_ctx is None or app_ctx.app is not self.app:
        app_ctx = self.app.app_context()
        app_ctx.push()
    else:
        app_ctx = None
    
    self._cv_tokens.append((_cv_request.set(self), app_ctx))
    
    # ä¼šè¯ç®¡ç†
    if self.session is None:
        session_interface = self.app.session_interface
        self.session = session_interface.open_session(self.app, self.request)
        if self.session is None:
            self.session = session_interface.make_null_session(self.app)
    
    # URLåŒ¹é…
    if self.url_adapter is not None:
        self.match_request()
```

**å¼‚å¸¸å®‰å…¨çš„èµ„æºæ¸…ç†** (`flask/ctx.py:396-431`)ï¼š

```python
def pop(self, exc: BaseException | None = _sentinel) -> None:
    clear_request = len(self._cv_tokens) == 1
    
    try:
        if clear_request:
            if exc is _sentinel:
                exc = sys.exc_info()[1]
            self.app.do_teardown_request(exc)
            
            # å…³é—­è¯·æ±‚èµ„æº
            request_close = getattr(self.request, "close", None)
            if request_close is not None:
                request_close()
    finally:
        ctx = _cv_request.get()
        token, app_ctx = self._cv_tokens.pop()
        _cv_request.reset(token)
        
        # é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼Œé¿å…ä¾èµ–GC
        if clear_request:
            ctx.request.environ["werkzeug.request"] = None
        
        if app_ctx is not None:
            app_ctx.pop(exc)
```

### è®¾è®¡æ™ºæ…§è§£æ

#### 1. Tokenç®¡ç†æœºåˆ¶

**åµŒå¥—ä¸Šä¸‹æ–‡æ”¯æŒ**ï¼š
```python
# æ”¯æŒä¸Šä¸‹æ–‡çš„åµŒå¥—ä½¿ç”¨
with app.app_context():
    print(current_app.name)  # å¤–å±‚ä¸Šä¸‹æ–‡
    
    with app.test_request_context():
        print(request.method)  # å†…å±‚ä¸Šä¸‹æ–‡
        print(current_app.name)  # å¤–å±‚ä¸Šä¸‹æ–‡ä»ç„¶å¯ç”¨
    
    print(current_app.name)  # å›åˆ°å¤–å±‚ä¸Šä¸‹æ–‡
```

**Tokenæ ˆçš„ç®¡ç†**ï¼š
```python
class AppContext:
    def __init__(self, app: Flask) -> None:
        # Tokenåˆ—è¡¨æ”¯æŒåµŒå¥—ä¸Šä¸‹æ–‡
        self._cv_tokens: list[contextvars.Token[AppContext]] = []
    
    def push(self) -> None:
        # æ¯æ¬¡pushéƒ½è®°å½•ä¸€ä¸ªtoken
        self._cv_tokens.append(_cv_app.set(self))
    
    def pop(self, exc=None) -> None:
        # popæ—¶ç§»é™¤æœ€åçš„tokenï¼Œæ”¯æŒåµŒå¥—
        _cv_app.reset(self._cv_tokens.pop())
```

#### 2. è‡ªåŠ¨ä¾èµ–ç®¡ç†

**RequestContextå¯¹AppContextçš„ä¾èµ–**ï¼š
```python
# RequestContextè‡ªåŠ¨ç¡®ä¿AppContextå­˜åœ¨
def push(self) -> None:
    app_ctx = _cv_app.get(None)
    if app_ctx is None or app_ctx.app is not self.app:
        # è‡ªåŠ¨åˆ›å»ºå¹¶æ¨å…¥AppContext
        app_ctx = self.app.app_context()
        app_ctx.push()
    else:
        app_ctx = None  # å·²å­˜åœ¨ï¼Œä¸éœ€è¦æˆ‘ä»¬ç®¡ç†
    
    # è®°å½•æ˜¯å¦éœ€è¦æ¸…ç†AppContext
    self._cv_tokens.append((_cv_request.set(self), app_ctx))
```

#### 3. å¼‚å¸¸å®‰å…¨ä¿è¯

**finallyå—çš„èµ„æºæ¸…ç†**ï¼š
```python
def pop(self, exc=None) -> None:
    try:
        # ä¸šåŠ¡é€»è¾‘ï¼šteardownå‡½æ•°è°ƒç”¨
        if clear_request:
            self.app.do_teardown_request(exc)
    finally:
        # æ— è®ºå¦‚ä½•éƒ½è¦æ¸…ç†èµ„æº
        ctx = _cv_request.get()
        token, app_ctx = self._cv_tokens.pop()
        _cv_request.reset(token)
        
        # é˜²æ­¢å†…å­˜æ³„æ¼
        if clear_request:
            ctx.request.environ["werkzeug.request"] = None
```

#### 4. å¾ªç¯å¼•ç”¨é˜²æŠ¤

**ä¸»åŠ¨æ–­å¼€å¾ªç¯å¼•ç”¨**ï¼š
```python
# é—®é¢˜ï¼šRequestå¯¹è±¡å¯èƒ½åŒ…å«å¯¹ç¯å¢ƒçš„å¼•ç”¨ï¼Œå½¢æˆå¾ªç¯
# è§£å†³ï¼šä¸»åŠ¨æ¸…ç†å¼•ç”¨ï¼Œä¸ä¾èµ–GC
if clear_request:
    ctx.request.environ["werkzeug.request"] = None
```

### _AppCtxGlobalsçš„namespaceè®¾è®¡

**å­—å…¸å¼APIçš„å¯¹è±¡å®ç°** (`flask/ctx.py:29-114`)ï¼š

```python
class _AppCtxGlobals:
    """è¯·æ±‚æœŸé—´å­˜å‚¨æ•°æ®çš„å‘½åç©ºé—´å¯¹è±¡"""
    
    def __getattr__(self, name: str) -> t.Any:
        try:
            return self.__dict__[name]
        except KeyError:
            raise AttributeError(name) from None
            
    def __setattr__(self, name: str, value: t.Any) -> None:
        self.__dict__[name] = value
        
    def get(self, name: str, default: t.Any | None = None) -> t.Any:
        """ç±»ä¼¼dict.getçš„å±æ€§è·å–"""
        return self.__dict__.get(name, default)
        
    def pop(self, name: str, default: t.Any = _sentinel) -> t.Any:
        """ç±»ä¼¼dict.popçš„å±æ€§ç§»é™¤"""
        if default is _sentinel:
            return self.__dict__.pop(name)
        else:
            return self.__dict__.pop(name, default)
            
    def setdefault(self, name: str, default: t.Any = None) -> t.Any:
        """ç±»ä¼¼dict.setdefaultçš„å±æ€§è®¾ç½®"""
        return self.__dict__.setdefault(name, default)
        
    def __contains__(self, item: str) -> bool:
        return item in self.__dict__
        
    def __iter__(self) -> t.Iterator[str]:
        return iter(self.__dict__)
```

**åŒé‡æ¥å£è®¾è®¡**ï¼š
```python
# æ—¢æ”¯æŒå¯¹è±¡å±æ€§è®¿é—®
g.user_id = 123
print(g.user_id)

# ä¹Ÿæ”¯æŒå­—å…¸é£æ ¼è®¿é—®
g['user_id'] = 123
print(g.get('user_id', 'default'))

# æ”¯æŒæ ‡å‡†å­—å…¸æ“ä½œ
if 'user_id' in g:
    user_id = g.pop('user_id')
```

### ä¸Šä¸‹æ–‡å¤åˆ¶æœºåˆ¶

**è¯·æ±‚ä¸Šä¸‹æ–‡çš„å¤åˆ¶** (`flask/ctx.py:337-355`)ï¼š

```python
def copy(self) -> RequestContext:
    """åˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡çš„å‰¯æœ¬ï¼Œç”¨äºgreenleté—´ç§»åŠ¨"""
    return self.__class__(
        self.app,
        environ=self.request.environ,
        request=self.request,
        session=self.session,
    )
```

**copy_current_request_contextè£…é¥°å™¨** (`flask/ctx.py:155-193`)ï¼š

```python
def copy_current_request_context(f: F) -> F:
    """è£…é¥°å™¨ï¼šä¿ç•™å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œç”¨äºgreenlet"""
    ctx = _cv_request.get(None)
    if ctx is None:
        raise RuntimeError(
            "'copy_current_request_context' can only be used when a request context is active"
        )
    
    ctx = ctx.copy()
    
    def wrapper(*args: t.Any, **kwargs: t.Any) -> t.Any:
        with ctx:
            return ctx.app.ensure_sync(f)(*args, **kwargs)
    
    return update_wrapper(wrapper, f)
```

### ä¸Šä¸‹æ–‡ç®¡ç†çš„å±‚æ¬¡ç»“æ„

```
åº”ç”¨å±‚ (Application Layer)
â”œâ”€â”€ Flaskåº”ç”¨å®ä¾‹
â”œâ”€â”€ é…ç½®ç®¡ç†  
â””â”€â”€ æ‰©å±•æ³¨å†Œ

ä¸Šä¸‹æ–‡å±‚ (Context Layer)  
â”œâ”€â”€ AppContext (åº”ç”¨ä¸Šä¸‹æ–‡)
â”‚   â”œâ”€â”€ current_app ä»£ç†
â”‚   â””â”€â”€ g å‘½åç©ºé—´å¯¹è±¡
â””â”€â”€ RequestContext (è¯·æ±‚ä¸Šä¸‹æ–‡)
    â”œâ”€â”€ request ä»£ç†
    â””â”€â”€ session ä»£ç†

å­˜å‚¨å±‚ (Storage Layer)
â”œâ”€â”€ ContextVar (_cv_app, _cv_request)
â”œâ”€â”€ LocalProxy (é€æ˜ä»£ç†)
â””â”€â”€ Tokenç®¡ç† (åµŒå¥—æ”¯æŒ)
```

### å®é™…åº”ç”¨åœºæ™¯

#### 1. æµ‹è¯•ç¯å¢ƒä¸­çš„ä¸Šä¸‹æ–‡ç®¡ç†

```python
import pytest
from flask import Flask, current_app, request

def test_application_context():
    app = Flask(__name__)
    
    # åœ¨åº”ç”¨ä¸Šä¸‹æ–‡å¤–æ— æ³•è®¿é—®current_app
    with pytest.raises(RuntimeError):
        current_app.config['SECRET_KEY']
    
    # åœ¨åº”ç”¨ä¸Šä¸‹æ–‡å†…å¯ä»¥è®¿é—®
    with app.app_context():
        current_app.config['SECRET_KEY'] = 'test-key'
        assert current_app.config['SECRET_KEY'] == 'test-key'

def test_request_context():
    app = Flask(__name__)
    
    # è¯·æ±‚ä¸Šä¸‹æ–‡è‡ªåŠ¨åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡
    with app.test_request_context('/hello?name=world'):
        assert current_app is not None  # åº”ç”¨ä¸Šä¸‹æ–‡è‡ªåŠ¨å­˜åœ¨
        assert request.path == '/hello'
        assert request.args['name'] == 'world'
```

#### 2. åå°ä»»åŠ¡ä¸­çš„ä¸Šä¸‹æ–‡ä¼ é€’

```python
import threading
from flask import copy_current_request_context

@app.route('/background')
def start_background_task():
    @copy_current_request_context
    def background_work():
        # è¿™é‡Œå¯ä»¥è®¿é—®è¯·æ±‚ä¸Šä¸‹æ–‡
        app = current_app._get_current_object()
        user_id = session.get('user_id')
        
        # æ‰§è¡Œè€—æ—¶æ“ä½œ
        time.sleep(10)
        
        # å‘é€ç»“æœ
        with app.app_context():
            send_result_notification(user_id)
    
    thread = threading.Thread(target=background_work)
    thread.start()
    
    return 'Task started'
```

#### 3. Celeryä»»åŠ¡ä¸­çš„ä¸Šä¸‹æ–‡ä½¿ç”¨

```python
from celery import Celery
from flask import Flask

celery = Celery(__name__)
app = Flask(__name__)

@celery.task
def process_data(data, app_config):
    # æ‰‹åŠ¨åˆ›å»ºåº”ç”¨ä¸Šä¸‹æ–‡
    temp_app = Flask(__name__)
    temp_app.config.update(app_config)
    
    with temp_app.app_context():
        # ç°åœ¨å¯ä»¥ä½¿ç”¨FlaskåŠŸèƒ½
        current_app.logger.info(f"Processing {data}")
        result = expensive_computation(data)
        return result
```

### æ€§èƒ½ä¼˜åŒ–è€ƒé‡

#### 1. ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€

```python
# é«˜é¢‘æ“ä½œçš„ä¼˜åŒ–
def optimized_bulk_operation():
    # é¿å…é‡å¤çš„ä¸Šä¸‹æ–‡è§£æ
    app = current_app._get_current_object()
    
    results = []
    for item in large_dataset:
        # ç›´æ¥ä½¿ç”¨appå¯¹è±¡ï¼Œé¿å…LocalProxyå¼€é”€
        result = app.process_item(item)
        results.append(result)
    
    return results
```

#### 2. å†…å­˜ä½¿ç”¨ä¼˜åŒ–

```python
# åŠæ—¶æ¸…ç†å¤§å¯¹è±¡
@app.teardown_request
def cleanup_request(exc=None):
    # æ¸…ç†è¯·æ±‚æœŸé—´çš„å¤§å¯¹è±¡
    if hasattr(g, 'large_data'):
        del g.large_data
    
    # æ¸…ç†æ•°æ®åº“è¿æ¥
    if hasattr(g, 'db'):
        g.db.close()
```

### å¯å€Ÿé‰´çš„è®¾è®¡æ¨¡å¼

1. **åµŒå¥—ä¸Šä¸‹æ–‡æ”¯æŒ**: Tokenæ ˆç®¡ç†å¤šå±‚ä¸Šä¸‹æ–‡
2. **è‡ªåŠ¨ä¾èµ–æ³¨å…¥**: æ™ºèƒ½çš„ä¸Šä¸‹æ–‡ä¾èµ–ç®¡ç†
3. **å¼‚å¸¸å®‰å…¨è®¾è®¡**: finallyå—ç¡®ä¿èµ„æºæ¸…ç†
4. **Namespaceå¯¹è±¡æ¨¡å¼**: å°†å­—å…¸æ¥å£åŒ…è£…ä¸ºå¯¹è±¡æ¥å£
5. **ä¸Šä¸‹æ–‡å¤åˆ¶æœºåˆ¶**: æ”¯æŒå¼‚æ­¥å’Œgreenletåœºæ™¯
6. **å†…å­˜æ³„æ¼é˜²æŠ¤**: ä¸»åŠ¨æ–­å¼€å¾ªç¯å¼•ç”¨
7. **åŒé‡æ¥å£è®¾è®¡**: åŒæ—¶æ”¯æŒå±æ€§å’Œå­—å…¸è®¿é—®

### æ¡†æ¶å¯¹æ¯”

| æ¡†æ¶ | ä¸Šä¸‹æ–‡ç­–ç•¥ | å­˜å‚¨æœºåˆ¶ | åµŒå¥—æ”¯æŒ | å¼‚æ­¥å…¼å®¹ |
|------|------------|----------|----------|----------|
| **Flask** | åˆ†å±‚ä¸Šä¸‹æ–‡ | ContextVar | âœ… Tokenæ ˆ | âœ… åŸç”Ÿæ”¯æŒ |
| **Django** | ä¸­é—´ä»¶ | çº¿ç¨‹å±€éƒ¨ | âŒ å•å±‚ | âš ï¸ éƒ¨åˆ†æ”¯æŒ |
| **FastAPI** | ä¾èµ–æ³¨å…¥ | å‡½æ•°å‚æ•° | âœ… è‡ªç„¶æ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ |
| **Tornado** | åç¨‹ä¸Šä¸‹æ–‡ | IOLoop | âœ… åç¨‹æ ˆ | âœ… åŸç”Ÿæ”¯æŒ |

### é«˜çº§åº”ç”¨æ¨¡å¼

#### 1. è‡ªå®šä¹‰ä¸Šä¸‹æ–‡ç®¡ç†å™¨

```python
from contextvars import ContextVar

class DatabaseContext:
    def __init__(self, db_url: str):
        self.db_url = db_url
        self.connection = None
        self._cv_token = None
    
    def __enter__(self):
        self.connection = create_connection(self.db_url)
        self._cv_token = _cv_db.set(self)
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        if self.connection:
            self.connection.close()
        if self._cv_token:
            _cv_db.reset(self._cv_token)

# ä½¿ç”¨
_cv_db: ContextVar[DatabaseContext] = ContextVar('database')
current_db = LocalProxy(_cv_db, 'connection')

with DatabaseContext('postgresql://...'):
    result = current_db.execute('SELECT * FROM users')
```

#### 2. ä¸Šä¸‹æ–‡è£…é¥°å™¨æ¨¡å¼

```python
def with_app_context(app):
    """è£…é¥°å™¨ï¼šç¡®ä¿å‡½æ•°åœ¨åº”ç”¨ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ"""
    def decorator(f):
        def wrapper(*args, **kwargs):
            with app.app_context():
                return f(*args, **kwargs)
        return wrapper
    return decorator

@with_app_context(app)
def send_email(to, subject, body):
    # è¿™é‡Œå¯ä»¥ä½¿ç”¨current_app
    smtp_config = current_app.config['SMTP_CONFIG']
    send_mail(smtp_config, to, subject, body)
```

### è®¾è®¡å“²å­¦æ€»ç»“

Flaskçš„ä¸Šä¸‹æ–‡ç³»ç»Ÿä½“ç°äº†ä»¥ä¸‹è®¾è®¡æ™ºæ…§ï¼š

1. **ç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨åŒ–**: è‡ªåŠ¨ç®¡ç†å¤æ‚çš„èµ„æºç”Ÿå‘½å‘¨æœŸ
2. **å¼‚å¸¸å®‰å…¨ä¼˜å…ˆ**: ç¡®ä¿å¼‚å¸¸æƒ…å†µä¸‹çš„èµ„æºæ¸…ç†
3. **æ¸è¿›å¼å¤æ‚åº¦**: ç®€å•ä½¿ç”¨æ—¶éšè—å¤æ‚æ€§
4. **å†…å­˜å®‰å…¨æ„è¯†**: ä¸»åŠ¨é˜²æ­¢å†…å­˜æ³„æ¼
5. **å‘å‰å…¼å®¹æ€§**: ContextVarçš„å¼•å…¥ä¸ç ´åç°æœ‰ä»£ç 
6. **æµ‹è¯•å‹å¥½è®¾è®¡**: æä¾›ä¾¿åˆ©çš„æµ‹è¯•ä¸Šä¸‹æ–‡å·¥å…·

è¿™ç§ä¸Šä¸‹æ–‡ç®¡ç†è®¾è®¡ä¸ä»…é€‚ç”¨äºWebæ¡†æ¶ï¼Œåœ¨ä»»ä½•éœ€è¦ç®¡ç†å¤æ‚çŠ¶æ€å’Œèµ„æºçš„ç³»ç»Ÿä¸­éƒ½å…·æœ‰é‡è¦çš„å‚è€ƒä»·å€¼ã€‚