# Flask æºç æ·±åº¦è§£æ - L2 æ ¸å¿ƒæœºåˆ¶æ·±å…¥åˆ†æ

## ğŸ“‹ æ¦‚è¿°

Flask ä½œä¸ºå¾®æ¡†æ¶çš„æ ¸å¿ƒåœ¨äºå…¶ç²¾å¿ƒè®¾è®¡çš„å››å¤§æ ¸å¿ƒæœºåˆ¶ï¼š**åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†**ã€**è¯·æ±‚å¤„ç†æµç¨‹**ã€**è·¯ç”±ç³»ç»Ÿå®ç°**å’Œ**ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿ**ã€‚æœ¬æ–‡æ·±å…¥å‰–æè¿™äº›æœºåˆ¶çš„å®ç°åŸç†ã€è®¾è®¡æ™ºæ…§ä»¥åŠå®ƒä»¬ä¹‹é—´çš„ååŒå·¥ä½œæ–¹å¼ã€‚

## ğŸ”„ åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†

### åº”ç”¨åˆ›å»ºé˜¶æ®µçš„è®¾è®¡æ™ºæ…§

å½“æˆ‘ä»¬æ‰§è¡Œ `app = Flask(__name__)` æ—¶ï¼Œè§¦å‘äº† Flask åº”ç”¨çš„æ ¸å¿ƒåˆå§‹åŒ–è¿‡ç¨‹ï¼š

```python
# flask/app.py:450
class Flask(_PackageBoundObject):
    def __init__(self, import_name, **kwargs):
        # 1. åŒ…è¾¹ç•Œå¯¹è±¡åˆå§‹åŒ–
        _PackageBoundObject.__init__(self, import_name, **kwargs)
        
        # 2. æ ¸å¿ƒæ•°æ®ç»“æ„åˆå§‹åŒ–
        self.config = self.make_config(instance_relative_config)
        self.url_map = Map()  # Werkzeugçš„Mapå¯¹è±¡
        self.view_functions = {}  # endpoint -> view_function
        self.error_handler_spec = {}  # é”™è¯¯å¤„ç†å™¨å±‚çº§æ˜ å°„
        
        # 3. é’©å­å‡½æ•°å­˜å‚¨ç»“æ„
        self.before_request_funcs = {None: []}
        self.after_request_funcs = {None: []}
        self.teardown_request_funcs = {None: []}
        
        # 4. æ‰©å±•æ”¯æŒåˆå§‹åŒ–
        self.extensions = {}
        
        # 5. æ¨¡æ¿ç³»ç»Ÿå»¶è¿Ÿåˆå§‹åŒ–
        self._jinja_env = None
```
*ä½ç½®ï¼šflask/app.py:450-490*

#### æ ¸å¿ƒè®¾è®¡åŸåˆ™

**1. å»¶è¿Ÿåˆå§‹åŒ–æ¨¡å¼**
```python
# flask/app.py:850
@cached_property
def jinja_env(self):
    """Jinja2ç¯å¢ƒçš„å»¶è¿Ÿåˆ›å»ºå’Œç¼“å­˜"""
    return self.create_jinja_environment()
```
*ä½ç½®ï¼šflask/app.py:850*

**è®¾è®¡æ™ºæ…§**ï¼š
- é¿å…ä¸å¿…è¦çš„å†…å­˜å¼€é”€
- åªæœ‰åœ¨çœŸæ­£éœ€è¦æ—¶æ‰åˆ›å»ºå¤æ‚å¯¹è±¡
- @cached_property ç¡®ä¿å•æ¬¡è®¡ç®—ï¼Œå¤šæ¬¡å¤ç”¨

**2. æ³¨å†Œè¡¨æ¨¡å¼çš„å»ºç«‹**
```python
# è§†å›¾å‡½æ•°æ³¨å†Œè¡¨çš„è®¾è®¡æ™ºæ…§
self.view_functions = {}  # endpoint -> view_function

# é”™è¯¯å¤„ç†å™¨çš„å±‚çº§è®¾è®¡
self.error_handler_spec = {
    None: {},  # åº”ç”¨çº§é”™è¯¯å¤„ç†å™¨
    'blueprint_name': {}  # è“å›¾çº§é”™è¯¯å¤„ç†å™¨
}
```

**è®¾è®¡æ™ºæ…§**ï¼š
- **è§£è€¦ URL å’Œå‡½æ•°**ï¼šendpoint ä½œä¸ºä¸­é—´å±‚ï¼Œæ”¯æŒ URL å˜æ›´
- **å±‚çº§ä½œç”¨åŸŸ**ï¼šè“å›¾çº§ > åº”ç”¨çº§çš„ä¼˜å…ˆçº§å¤„ç†
- **æ‰©å±•æ€§æ”¯æŒ**ï¼šæ–°çš„ä½œç”¨åŸŸç±»å‹æ˜“äºæ·»åŠ 

### é…ç½®ç³»ç»Ÿçš„æ·±åº¦é›†æˆ

Flask çš„é…ç½®ç³»ç»Ÿä¸æ˜¯å­¤ç«‹çš„ï¼Œè€Œæ˜¯ä¸å…¶ä»–æ ¸å¿ƒæœºåˆ¶æ·±åº¦é›†æˆï¼š

```python
# flask/config.py:35
class Config(dict):
    """Flaské…ç½®ç±»ï¼Œç»§æ‰¿è‡ªdictä½†æœ‰ç‰¹æ®Šè¡Œä¸º"""
    
    def from_object(self, obj):
        """ä»å¯¹è±¡åŠ è½½é…ç½®ï¼ŒåªåŠ è½½å¤§å†™å±æ€§"""
        if isinstance(obj, str):
            obj = import_string(obj)
        for key in dir(obj):
            if key.isupper():  # çº¦å®šï¼šåªåŠ è½½å¤§å†™çš„å±æ€§
                self[key] = getattr(obj, key)
```
*ä½ç½®ï¼šflask/config.py:35-50*

#### é…ç½®ä¸å…¶ä»–ç³»ç»Ÿçš„ååŒ

**é…ç½®å½±å“è·¯ç”±è¡Œä¸º**ï¼š
```python
# åœ¨Flask.__init__ä¸­
self.url_map = Map(
    host_matching=self.config.get('SERVER_NAME') is not None,
    strict_slashes=self.config.get('STRICT_SLASHES', True)
)
```

**é…ç½®å½±å“æ¨¡æ¿ç¯å¢ƒ**ï¼š
```python
def create_jinja_environment(self):
    options = dict(self.jinja_options)
    if self.config.get('TEMPLATES_AUTO_RELOAD'):
        options['auto_reload'] = True
    return self.jinja_environment(self, **options)
```

## ğŸŒŠ è¯·æ±‚å¤„ç†æµç¨‹æ·±å…¥å‰–æ

### WSGI åˆ° Python å‡½æ•°çš„å®Œæ•´é“¾æ¡

Flask çš„è¯·æ±‚å¤„ç†æ˜¯ä¸€ä¸ªç²¾å¿ƒè®¾è®¡çš„æµæ°´çº¿ï¼š

```
WSGIæœåŠ¡å™¨ â†’ Flask.wsgi_app() â†’ RequestContext â†’ dispatch_request() â†’ view_function â†’ Response
```

#### æ ¸å¿ƒå¤„ç†æµç¨‹åˆ†æ

**1. WSGI æ¥å£å±‚çš„å¼‚å¸¸å®‰å…¨è®¾è®¡**
```python
# flask/app.py:2090
def wsgi_app(self, environ, start_response):
    """WSGIåº”ç”¨çš„æ ¸å¿ƒå®ç°"""
    ctx = self.request_context(environ)  # åˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡
    error = None
    try:
        try:
            ctx.push()  # ä¸Šä¸‹æ–‡å…¥æ ˆï¼Œæ¿€æ´»çº¿ç¨‹å±€éƒ¨å­˜å‚¨
            response = self.full_dispatch_request()
        except Exception as e:
            error = e
            response = self.handle_exception(e)
        except:  # å¤„ç†ç³»ç»Ÿé€€å‡ºç­‰ç‰¹æ®Šå¼‚å¸¸
            error = sys.exc_info()[1]
            raise
        return response(environ, start_response)
    finally:
        if self.should_ignore_error(error):
            error = None
        ctx.auto_pop(error)  # ä¸Šä¸‹æ–‡å‡ºæ ˆï¼Œç¡®ä¿èµ„æºæ¸…ç†
```
*ä½ç½®ï¼šflask/app.py:2090-2105*

**è®¾è®¡æ™ºæ…§**ï¼š
- **å¼‚å¸¸å®‰å…¨ä¿è¯**ï¼šæ— è®ºå‘ç”Ÿä»€ä¹ˆå¼‚å¸¸ï¼Œä¸Šä¸‹æ–‡éƒ½ä¼šè¢«æ­£ç¡®æ¸…ç†
- **åˆ†å±‚å¼‚å¸¸å¤„ç†**ï¼šåŒºåˆ†åº”ç”¨å¼‚å¸¸å’Œç³»ç»Ÿå¼‚å¸¸
- **èµ„æºç®¡ç†**ï¼štry-finally ç¡®ä¿èµ„æºé‡Šæ”¾

**2. å®Œæ•´çš„è¯·æ±‚åˆ†å‘æœºåˆ¶**
```python
# flask/app.py:1950
def full_dispatch_request(self):
    """å®Œæ•´çš„è¯·æ±‚åˆ†å‘ï¼ŒåŒ…å«é’©å­å‡½æ•°å¤„ç†"""
    # 1. é¦–æ¬¡è¯·æ±‚åˆå§‹åŒ–
    self.try_trigger_before_first_request_functions()
    
    try:
        # 2. è¯·æ±‚å¼€å§‹ä¿¡å·
        request_started.send(self)
        
        # 3. å‰ç½®å¤„ç†ï¼ˆbefore_requesté’©å­ï¼‰
        rv = self.preprocess_request()
        if rv is None:
            # 4. æ ¸å¿ƒè¯·æ±‚åˆ†å‘
            rv = self.dispatch_request()
    except Exception as e:
        # 5. ç”¨æˆ·å¼‚å¸¸å¤„ç†
        rv = self.handle_user_exception(e)
    
    # 6. å“åº”åå¤„ç†
    return self.finalize_request(rv)
```
*ä½ç½®ï¼šflask/app.py:1950-1970*

**3. é’©å­å‡½æ•°çš„å±‚çº§æ‰§è¡Œæœºåˆ¶**
```python
def preprocess_request(self):
    """before_requesté’©å­çš„å±‚çº§æ‰§è¡Œ"""
    bp = _request_ctx_stack.top.request.blueprint
    
    # å…ˆæ‰§è¡Œåº”ç”¨çº§é’©å­ï¼Œå†æ‰§è¡Œè“å›¾çº§é’©å­
    funcs = self.before_request_funcs.get(None, ())
    if bp is not None and bp in self.before_request_funcs:
        funcs = chain(funcs, self.before_request_funcs[bp])
    
    for func in funcs:
        rv = func()
        if rv is not None:
            return rv  # æå‰è¿”å›ï¼Œä¸­æ–­è¯·æ±‚å¤„ç†
```

**è®¾è®¡æ™ºæ…§**ï¼š
- **å±‚æ¬¡åŒ–æ‰§è¡Œ**ï¼šåº”ç”¨çº§ â†’ è“å›¾çº§çš„æœ‰åºæ‰§è¡Œ
- **æå‰ä¸­æ–­æœºåˆ¶**ï¼šæ”¯æŒè®¤è¯æ£€æŸ¥ã€æƒé™æ§åˆ¶
- **ä¿¡å·ç³»ç»Ÿé›†æˆ**ï¼šä¸ºç¬¬ä¸‰æ–¹æ‰©å±•æä¾›ç›‘å¬ç‚¹

### æ ¸å¿ƒåˆ†å‘é€»è¾‘

```python
# flask/app.py:1840
def dispatch_request(self):
    """è¯·æ±‚è°ƒåº¦çš„æ ¸å¿ƒé€»è¾‘"""
    # 1. æ£€æŸ¥è·¯ç”±å¼‚å¸¸
    req = _request_ctx_stack.top.request
    if req.routing_exception is not None:
        self.raise_routing_exception(req)
    
    # 2. è·å–è·¯ç”±ä¿¡æ¯
    rule, values = req.url_rule, req.view_args
    
    # 3. é€šè¿‡endpointæŸ¥æ‰¾è§†å›¾å‡½æ•°
    endpoint = rule.endpoint
    view_function = self.view_functions[endpoint]
    
    # 4. è°ƒç”¨è§†å›¾å‡½æ•°ï¼Œä¼ å…¥è·¯ç”±å‚æ•°
    return view_function(**values)
```
*ä½ç½®ï¼šflask/app.py:1840-1855*

**è®¾è®¡è€ƒè™‘åˆ†æ**ï¼š
- **é”™è¯¯æå‰å¤„ç†**ï¼šè·¯ç”±é”™è¯¯æ— éœ€è¿›å…¥å¤æ‚å¤„ç†é€»è¾‘
- **å‚æ•°ä¼ é€’ä¼˜é›…æ€§**ï¼šä½¿ç”¨ **values æ”¯æŒä»»æ„æ•°é‡å‚æ•°
- **endpoint é—´æ¥å¯»å€**ï¼šæ”¯æŒå¤š URLã€è“å›¾å‘½åç©ºé—´

## ğŸ§­ è·¯ç”±ç³»ç»Ÿå®ç°åŸç†

### è·¯ç”±æ³¨å†Œçš„å®Œæ•´æœºåˆ¶

Flask çš„è£…é¥°å™¨è·¯ç”±èƒŒåæ˜¯å¤æ‚çš„æ³¨å†Œå’Œç¼–è¯‘è¿‡ç¨‹ï¼š

```python
# flask/app.py:1520
def route(self, rule, **options):
    """è£…é¥°å™¨å·¥å‚æ¨¡å¼çš„å®ç°"""
    def decorator(f):
        endpoint = options.pop('endpoint', None)
        self.add_url_rule(rule, endpoint, f, **options)
        return f  # å‡½æ•°ä¿æŒåŸæ ·ï¼Œæ”¯æŒæµ‹è¯•å’Œç›´æ¥è°ƒç”¨
    return decorator

def add_url_rule(self, rule, endpoint=None, view_func=None, **options):
    """URLè§„åˆ™æ³¨å†Œçš„æ ¸å¿ƒå®ç°"""
    if endpoint is None:
        endpoint = _endpoint_from_view_func(view_func)
    
    # æ£€æŸ¥é‡å¤æ³¨å†Œ
    old_func = self.view_functions.get(endpoint)
    if old_func is not None and old_func != view_func:
        raise AssertionError('View function mapping is overwriting')
    
    # åˆ›å»ºWerkzeug Ruleå¯¹è±¡
    rule_obj = Rule(rule, methods=methods, **options)
    
    # æ·»åŠ åˆ°URLæ˜ å°„å’Œè§†å›¾å‡½æ•°æ³¨å†Œè¡¨
    self.url_map.add(rule_obj)
    if view_func is not None:
        self.view_functions[endpoint] = view_func
```
*ä½ç½®ï¼šflask/app.py:1520-1580*

### è·¯ç”±åŒ¹é…çš„æ€§èƒ½ä¼˜åŒ–

**1. Werkzeug Map çš„ä¼˜åŒ–ç­–ç•¥**
```python
class Map:
    def __init__(self):
        self._rules = []           # æ‰€æœ‰è·¯ç”±è§„åˆ™
        self._rules_by_endpoint = {}  # endpoint -> rule å¿«é€ŸæŸ¥æ‰¾
        self._remap = True         # é‡æ–°ç¼–è¯‘æ ‡è®°
        self._adapter = None       # URLé€‚é…å™¨ç¼“å­˜
```

**æ€§èƒ½ä¼˜åŒ–ç‚¹**ï¼š
- **é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼**ï¼šRule å¯¹è±¡åˆ›å»ºæ—¶ç¼–è¯‘ï¼Œé¿å…è¿è¡Œæ—¶å¼€é”€
- **é€‚é…å™¨ç¼“å­˜**ï¼šMapAdapter å¯¹è±¡ç¼“å­˜ï¼Œå‡å°‘åˆ›å»ºå¼€é”€  
- **åˆ†å±‚æŸ¥æ‰¾**ï¼šendpoint æŸ¥æ‰¾ O(1)ï¼ŒURL åŒ¹é… O(n) ä½†ä½¿ç”¨ä¼˜åŒ–åçš„æ­£åˆ™

**2. è·¯ç”±åŒ¹é…çš„æ‰§è¡Œæµç¨‹**
```python
def match_request(self):
    """åœ¨RequestContextåˆå§‹åŒ–ä¸­æ‰§è¡Œè·¯ç”±åŒ¹é…"""
    url_adapter = self.app.create_url_adapter(self.request)
    try:
        # è·¯ç”±åŒ¹é…ï¼Œè¿”å›endpointå’Œå‚æ•°
        result = url_adapter.match(return_rule=True)
        self.request.url_rule, self.request.view_args = result
    except HTTPException as e:
        # è·¯ç”±å¼‚å¸¸å»¶è¿Ÿå¤„ç†ï¼Œä¸ç«‹å³æŠ›å‡º
        self.request.routing_exception = e
```

**è®¾è®¡æ™ºæ…§**ï¼š
- **å¼‚å¸¸å»¶è¿Ÿå¤„ç†**ï¼šåŒ¹é…å¤±è´¥æ—¶ä¿å­˜å¼‚å¸¸ï¼Œå»¶è¿Ÿåˆ°çœŸæ­£éœ€è¦æ—¶å¤„ç†
- **ç»“æœç¼“å­˜**ï¼šåŒ¹é…ç»“æœå­˜å‚¨åœ¨ request å¯¹è±¡ä¸­ï¼Œé¿å…é‡å¤è®¡ç®—

### åŠ¨æ€è·¯ç”±å’Œç±»å‹è½¬æ¢

```python
# è·¯ç”±è§„åˆ™ç¤ºä¾‹
@app.route('/user/<int:user_id>')
@app.route('/post/<slug:title>')  
@app.route('/category/<path:category_path>')
```

**ç±»å‹è½¬æ¢å™¨çš„å·¥ä½œåŸç†**ï¼š
```python
# Werkzeugå†…ç½®çš„è½¬æ¢å™¨
DEFAULT_CONVERTERS = {
    'default':          UnicodeConverter,
    'string':           UnicodeConverter, 
    'any':              AnyConverter,
    'path':             PathConverter,
    'int':              IntegerConverter,
    'float':            FloatConverter,
    'uuid':             UUIDConverter,
}
```

**è®¾è®¡ä»·å€¼**ï¼š
- **ç±»å‹å®‰å…¨**ï¼šURL å‚æ•°åœ¨åˆ°è¾¾è§†å›¾å‡½æ•°å‰å·²å®Œæˆç±»å‹è½¬æ¢
- **éªŒè¯å‰ç½®**ï¼šæ— æ•ˆå‚æ•°ç›´æ¥è¿”å› 404ï¼Œä¸è¿›å…¥ä¸šåŠ¡é€»è¾‘
- **æ‰©å±•æ€§**ï¼šæ”¯æŒè‡ªå®šä¹‰è½¬æ¢å™¨

## ğŸ§  ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿæ·±åº¦å‰–æ

### åŒé‡ä¸Šä¸‹æ–‡çš„è®¾è®¡åŠ¨æœº

Flask é‡‡ç”¨ **åº”ç”¨ä¸Šä¸‹æ–‡** å’Œ **è¯·æ±‚ä¸Šä¸‹æ–‡** åˆ†ç¦»çš„è®¾è®¡ï¼š

#### åº”ç”¨ä¸Šä¸‹æ–‡ (AppContext)
```python
# flask/ctx.py:45
class AppContext:
    """åº”ç”¨çº§åˆ«çš„ä¸Šä¸‹æ–‡ï¼Œç”Ÿå‘½å‘¨æœŸè¾ƒé•¿"""
    def __init__(self, app):
        self.app = app
        self.url_adapter = None
        self.g = app.app_ctx_globals_class()  # åº”ç”¨çº§å…¨å±€å¯¹è±¡
```
*ä½ç½®ï¼šflask/ctx.py:45-60*

**ç®¡ç†å†…å®¹**ï¼š
- åº”ç”¨é…ç½®ä¿¡æ¯
- åº”ç”¨çº§å…¨å±€å˜é‡
- URL é€‚é…å™¨ï¼ˆå¯è·¨è¯·æ±‚å¤ç”¨ï¼‰

#### è¯·æ±‚ä¸Šä¸‹æ–‡ (RequestContext)
```python  
# flask/ctx.py:185
class RequestContext:
    """è¯·æ±‚çº§åˆ«çš„ä¸Šä¸‹æ–‡ï¼Œæ¯ä¸ªè¯·æ±‚ç‹¬ç«‹"""
    def __init__(self, app, environ, request=None, session=None):
        self.app = app
        self.request = request or app.request_class(environ)
        self.session = session
        self.flashes = None
        self._implicit_app_ctx_stack = []
```
*ä½ç½®ï¼šflask/ctx.py:185-200*

**ç®¡ç†å†…å®¹**ï¼š
- HTTP è¯·æ±‚æ•°æ®
- ä¼šè¯ä¿¡æ¯
- é—ªå­˜æ¶ˆæ¯
- è¯·æ±‚çº§å…¨å±€å˜é‡

#### åˆ†ç¦»çš„æ ¸å¿ƒä»·å€¼

**1. ç”Ÿå‘½å‘¨æœŸå·®å¼‚åŒ–ç®¡ç†**
- **åº”ç”¨ä¸Šä¸‹æ–‡**ï¼šç”Ÿå‘½å‘¨æœŸé•¿ï¼Œå¯è·¨è¯·æ±‚å¤ç”¨
- **è¯·æ±‚ä¸Šä¸‹æ–‡**ï¼šç”Ÿå‘½å‘¨æœŸçŸ­ï¼Œè¯·æ±‚ç»“æŸå³é”€æ¯

**2. å†…å­˜æ•ˆç‡ä¼˜åŒ–**
- åº”ç”¨çº§æ•°æ®é¿å…é‡å¤åˆ›å»º
- è¯·æ±‚çº§æ•°æ®ä¸¥æ ¼éš”ç¦»ï¼Œé˜²æ­¢æ³„æ¼

**3. åŠŸèƒ½ç‹¬ç«‹æ€§**
- CLI å‘½ä»¤åªéœ€åº”ç”¨ä¸Šä¸‹æ–‡
- æµ‹è¯•åœºæ™¯å¯ä»¥ç‹¬ç«‹æ§åˆ¶ä¸Šä¸‹æ–‡

### LocalStack çš„çº¿ç¨‹å®‰å…¨æœºåˆ¶

```python
# werkzeug/local.py
class LocalStack:
    """çº¿ç¨‹å®‰å…¨çš„æ ˆå®ç°"""
    def __init__(self):
        self._local = Local()  # çº¿ç¨‹æœ¬åœ°å­˜å‚¨å¯¹è±¡

    def push(self, obj):
        """å°†å¯¹è±¡æ¨å…¥å½“å‰çº¿ç¨‹çš„æ ˆé¡¶"""
        rv = getattr(self._local, 'stack', None)
        if rv is None:
            self._local.stack = rv = []
        rv.append(obj)
        return rv

    def pop(self):
        """ä»å½“å‰çº¿ç¨‹çš„æ ˆä¸­å¼¹å‡ºå¯¹è±¡"""
        stack = getattr(self._local, 'stack', None)
        if stack is None:
            return None
        elif len(stack) == 1:
            release_local(self._local)  # é‡Šæ”¾çº¿ç¨‹å­˜å‚¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            return stack[-1]
        else:
            return stack.pop()

    @property
    def top(self):
        """è·å–å½“å‰çº¿ç¨‹æ ˆé¡¶å¯¹è±¡"""
        try:
            return self._local.stack[-1]
        except (AttributeError, IndexError):
            return None
```

#### Local å¯¹è±¡çš„å®ç°åŸç†

```python
class Local:
    """çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„å®ç°"""
    def __init__(self):
        self.__storage__ = {}  # {thread_id: {attr_name: value}}
        self.__ident_func__ = get_ident  # çº¿ç¨‹IDè·å–å‡½æ•°

    def __getattr__(self, name):
        ident = self.__ident_func__()  # è·å–å½“å‰çº¿ç¨‹ID
        try:
            return self.__storage__[ident][name]
        except KeyError:
            raise AttributeError(name)

    def __setattr__(self, name, value):
        if name in ('__storage__', '__ident_func__'):
            object.__setattr__(self, name, value)
        else:
            ident = self.__ident_func__()
            storage = self.__storage__.setdefault(ident, {})
            storage[name] = value
```

**æŠ€æœ¯æ´å¯Ÿ**ï¼š
- **æ ˆç»“æ„**ï¼šæ”¯æŒä¸Šä¸‹æ–‡åµŒå¥—ï¼ˆæµ‹è¯•ã€å­è¯·æ±‚ï¼‰
- **çº¿ç¨‹éš”ç¦»**ï¼šæ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹çš„å­˜å‚¨ç©ºé—´
- **å†…å­˜ç®¡ç†**ï¼šè‡ªåŠ¨æ¸…ç†æœºåˆ¶é˜²æ­¢æ³„æ¼

### LocalProxy çš„é€æ˜ä»£ç†

```python
# werkzeug/local.py
class LocalProxy:
    """é€æ˜ä»£ç†å¯¹è±¡çš„å®ç°"""
    def __init__(self, local, name=None):
        object.__setattr__(self, '_LocalProxy__local', local)
        object.__setattr__(self, '_LocalProxy__name', name)

    def _get_current_object(self):
        """è·å–å½“å‰çº¿ç¨‹çš„å®é™…å¯¹è±¡"""
        if not hasattr(self.__local, '__release_local__'):
            return self.__local()  # å¦‚æœæ˜¯å‡½æ•°ï¼Œè°ƒç”¨å®ƒ
        try:
            return getattr(self.__local, self.__name)
        except AttributeError:
            raise RuntimeError('object unbound')

    def __getattr__(self, name):
        if name == '__members__':
            return dir(self._get_current_object())
        return getattr(self._get_current_object(), name)

    def __setattr__(self, name, value):
        if name in ('_LocalProxy__local', '_LocalProxy__name'):
            object.__setattr__(self, name, value)
        else:
            setattr(self._get_current_object(), name, value)
```

#### Flask ä¸­çš„å…¨å±€å¯¹è±¡

```python
# flask/globals.py:35
_request_ctx_stack = LocalStack()
_app_ctx_stack = LocalStack()

# å…¨å±€ä»£ç†å¯¹è±¡çš„å®šä¹‰
request = LocalProxy(lambda: _request_ctx_stack.top.request)
g = LocalProxy(lambda: _app_ctx_stack.top.g)
session = LocalProxy(lambda: _request_ctx_stack.top.session)  
current_app = LocalProxy(lambda: _app_ctx_stack.top.app)
```
*ä½ç½®ï¼šflask/globals.py:35-40*

**è®¾è®¡æ™ºæ…§**ï¼š
- **å»¶è¿Ÿç»‘å®š**ï¼šä½¿ç”¨ lambda å‡½æ•°å®ç°è¿è¡Œæ—¶è§£æ
- **é€æ˜è®¿é—®**ï¼šä»£ç†å¯¹è±¡ä½¿ç”¨èµ·æ¥ä¸çœŸå®å¯¹è±¡æ— å¼‚
- **é”™è¯¯å‹å¥½**ï¼šæ— ä¸Šä¸‹æ–‡æ—¶æŠ›å‡ºæ¸…æ™°çš„ RuntimeError

### ä¸Šä¸‹æ–‡ç”Ÿå‘½å‘¨æœŸç®¡ç†

```python
# flask/ctx.py:300
class RequestContext:
    def push(self):
        """æ¨å…¥è¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå¤„ç†åº”ç”¨ä¸Šä¸‹æ–‡ä¾èµ–"""
        # 1. æ£€æŸ¥preservedä¸Šä¸‹æ–‡
        top = _request_ctx_stack.top
        if top is not None and top.preserved:
            top.pop(top._preserved_exc)

        # 2. ç¡®ä¿åº”ç”¨ä¸Šä¸‹æ–‡å­˜åœ¨
        app_ctx = _app_ctx_stack.top
        if app_ctx is None or app_ctx.app != self.app:
            app_ctx = self.app.app_context()
            app_ctx.push()
            self._implicit_app_ctx_stack.append(app_ctx)
        else:
            self._implicit_app_ctx_stack.append(None)

        # 3. æ¨å…¥è¯·æ±‚ä¸Šä¸‹æ–‡å¹¶åˆå§‹åŒ–ä¼šè¯
        _request_ctx_stack.push(self)
        self.session = self.app.open_session(self.request)
        if self.session is None:
            self.session = self.app.make_null_session()
```
*ä½ç½®ï¼šflask/ctx.py:300-330*

**ç”Ÿå‘½å‘¨æœŸæ™ºæ…§**ï¼š
- **è‡ªåŠ¨åº”ç”¨ä¸Šä¸‹æ–‡ç®¡ç†**ï¼šè¯·æ±‚ä¸Šä¸‹æ–‡è‡ªåŠ¨ç¡®ä¿åº”ç”¨ä¸Šä¸‹æ–‡å­˜åœ¨
- **å¼‚å¸¸å®‰å…¨æ¸…ç†**ï¼štry-finally ç¡®ä¿èµ„æºæ­£ç¡®é‡Šæ”¾  
- **ä¼šè¯å»¶è¿Ÿå¤„ç†**ï¼šä¼šè¯åœ¨ push æ—¶åˆ›å»ºï¼Œpop æ—¶ä¿å­˜

## ğŸ¤ æ ¸å¿ƒæœºåˆ¶çš„ååŒå·¥ä½œ

### å®Œæ•´è¯·æ±‚å¤„ç†çš„ååŒé“¾æ¡

```python
# å®Œæ•´çš„ååŒå·¥ä½œæµç¨‹
def wsgi_app(self, environ, start_response):
    # æ­¥éª¤1ï¼šä¸Šä¸‹æ–‡ç³»ç»Ÿ - åˆ›å»ºå’Œç®¡ç†è¯·æ±‚çŠ¶æ€
    ctx = self.request_context(environ)
    
    try:
        # æ­¥éª¤2ï¼šä¸Šä¸‹æ–‡ç³»ç»Ÿ - æ¿€æ´»çº¿ç¨‹å±€éƒ¨å­˜å‚¨
        ctx.push()  # åŒ…å«ä¼šè¯åˆå§‹åŒ–ã€è·¯ç”±åŒ¹é…
        
        # æ­¥éª¤3ï¼šè¯·æ±‚å¤„ç†ç³»ç»Ÿ - å®Œæ•´åˆ†å‘æµç¨‹
        response = self.full_dispatch_request()
        # â”œâ”€ preprocess_request() - é’©å­å‡½æ•°ç³»ç»Ÿ
        # â”œâ”€ dispatch_request()   - è·¯ç”±ç³»ç»Ÿ + è§†å›¾è°ƒç”¨
        # â””â”€ finalize_request()   - å“åº”åå¤„ç†
        
    except Exception as e:
        # æ­¥éª¤4ï¼šå¼‚å¸¸å¤„ç†ç³»ç»Ÿ - ç»Ÿä¸€å¼‚å¸¸å¤„ç†
        response = self.handle_exception(e)
    finally:
        # æ­¥éª¤5ï¼šä¸Šä¸‹æ–‡ç³»ç»Ÿ - èµ„æºæ¸…ç†å’Œä¼šè¯ä¿å­˜
        ctx.auto_pop(error)
    
    # æ­¥éª¤6ï¼šWSGIç³»ç»Ÿ - æ ‡å‡†HTTPå“åº”
    return response(environ, start_response)
```

### é…ç½®ç³»ç»Ÿçš„æ·±åº¦é›†æˆ

**é…ç½®å½±å“å¤šä¸ªç³»ç»Ÿçš„è¡Œä¸º**ï¼š

```python
# é…ç½® â†’ è·¯ç”±ç³»ç»Ÿ
self.url_map = Map(
    host_matching=self.config.get('SERVER_NAME') is not None,
    strict_slashes=self.config.get('STRICT_SLASHES', True)
)

# é…ç½® â†’ æ¨¡æ¿ç³»ç»Ÿ  
def create_jinja_environment(self):
    options = {}
    if self.config.get('TEMPLATES_AUTO_RELOAD'):
        options['auto_reload'] = True
    return self.jinja_environment(self, **options)

# é…ç½® â†’ ä¼šè¯ç³»ç»Ÿ
def open_session(self, request):
    """ä¼šè¯å®‰å…¨æ€§ä¾èµ–SECRET_KEYé…ç½®"""
    return self.session_interface.open_session(self, request)
```

### æ‰©å±•ç³»ç»Ÿçš„å¤šé‡é›†æˆ

```python
# å…¸å‹çš„æ‰©å±•é›†æˆæ¨¡å¼
class SQLAlchemy:
    def init_app(self, app, **kwargs):
        # 1. æ‰©å±•æ³¨å†Œ - çŠ¶æ€å­˜å‚¨
        app.extensions['sqlalchemy'] = _SQLAlchemyState(self)
        
        # 2. é…ç½®ç³»ç»Ÿé›†æˆ - å‚æ•°ä¼ é€’
        app.config.setdefault('SQLALCHEMY_DATABASE_URI', 'sqlite://')
        
        # 3. é’©å­å‡½æ•°é›†æˆ - ç”Ÿå‘½å‘¨æœŸä»‹å…¥
        @app.teardown_appcontext
        def shutdown_session(exception=None):
            self.session.remove()
        
        # 4. CLIç³»ç»Ÿé›†æˆ - å‘½ä»¤è¡Œå·¥å…·
        app.cli.add_command(db_cli)

# 5. ä¸Šä¸‹æ–‡ç³»ç»Ÿé›†æˆ - è¯·æ±‚çº§æ•°æ®å­˜å‚¨
def get_db():
    if 'db' not in g:
        g.db = sqlite3.connect(current_app.config['DATABASE'])
    return g.db
```

## ğŸ¯ æ ¸å¿ƒæœºåˆ¶çš„è®¾è®¡æ´å¯Ÿ

### è®¾è®¡åŸåˆ™æ€»ç»“

**1. åˆ†å±‚ä½†ä¸å­¤ç«‹**
- æ¯ä¸ªæœºåˆ¶æœ‰æ˜ç¡®çš„èŒè´£è¾¹ç•Œ
- é€šè¿‡æ ‡å‡†åŒ–æ¥å£ç´§å¯†åä½œ
- é¿å…äº†å±‚é—´çš„è¿‡åº¦è€¦åˆ

**2. ç”Ÿå‘½å‘¨æœŸçš„ç»Ÿä¸€ç®¡ç†**  
- åˆ›å»ºé˜¶æ®µï¼šå»¶è¿Ÿåˆå§‹åŒ–ï¼ŒæŒ‰éœ€åˆ›å»º
- æ¿€æ´»é˜¶æ®µï¼šä¸Šä¸‹æ–‡é©±åŠ¨ï¼Œèµ„æºåˆ†é…
- æ‰§è¡Œé˜¶æ®µï¼šååŒå·¥ä½œï¼Œæ•°æ®æµè½¬  
- æ¸…ç†é˜¶æ®µï¼šå¼‚å¸¸å®‰å…¨ï¼Œèµ„æºé‡Šæ”¾

**3. å¯æ‰©å±•æ€§çš„ç³»ç»ŸåŒ–æ”¯æŒ**
- å¤šé‡é›†æˆç‚¹ï¼šé…ç½®ã€é’©å­ã€ä¿¡å·ã€CLI
- æ ‡å‡†åŒ–æ¨¡å¼ï¼šinit_appã€teardownã€çŠ¶æ€ç®¡ç†
- ä¸Šä¸‹æ–‡æ„ŸçŸ¥ï¼šæ‰©å±•åˆ©ç”¨ Flask çš„ä¸Šä¸‹æ–‡ç³»ç»Ÿ

**4. é”™è¯¯å¤„ç†çš„å…¨å±€ä¸€è‡´æ€§**
- å¼‚å¸¸ä¼ æ’­ï¼šåº•å±‚å¼‚å¸¸å‘ä¸Šä¼ æ’­
- å¼‚å¸¸è½¬æ¢ï¼šå†…éƒ¨å¼‚å¸¸è½¬æ¢ä¸º HTTP å“åº”  
- èµ„æºå®‰å…¨ï¼šå¼‚å¸¸æ—¶èµ„æºä»èƒ½æ­£ç¡®æ¸…ç†

**5. æ€§èƒ½ä¼˜åŒ–çš„ç³»ç»ŸåŒ–æ€è€ƒ**
- å»¶è¿ŸåŠ è½½ï¼šåªåœ¨éœ€è¦æ—¶åˆ›å»ºå¯¹è±¡
- ç¼“å­˜å¤ç”¨ï¼šç¼–è¯‘ç»“æœå’Œé€‚é…å™¨ç¼“å­˜
- å†…å­˜ç®¡ç†ï¼šä¸Šä¸‹æ–‡è‡ªåŠ¨æ¸…ç†ï¼Œé¿å…æ³„æ¼
- çƒ­è·¯å¾„ä¼˜åŒ–ï¼šå…³é”®è·¯å¾„çš„æ€§èƒ½è°ƒä¼˜

### æŠ€æœ¯åˆ›æ–°ç‚¹

**1. åŒé‡ä¸Šä¸‹æ–‡çš„åˆ†ç¦»è®¾è®¡**
- è§£å†³äº†åº”ç”¨çº§å’Œè¯·æ±‚çº§çŠ¶æ€çš„ä¸åŒç”Ÿå‘½å‘¨æœŸéœ€æ±‚
- æä¾›äº†çµæ´»çš„ä¸Šä¸‹æ–‡åµŒå¥—å’Œç®¡ç†èƒ½åŠ›
- æ”¯æŒäº†å¤šåº”ç”¨åœºæ™¯å’Œæµ‹è¯•éš”ç¦»

**2. LocalProxy çš„é€æ˜ä»£ç†**
- åœ¨ä¿æŒå…¨å±€å˜é‡ä¾¿åˆ©æ€§çš„åŒæ—¶å®ç°äº†çº¿ç¨‹å®‰å…¨
- é€šè¿‡å»¶è¿Ÿç»‘å®šå®ç°äº†åŠ¨æ€è§£æ
- å®Œæ•´çš„é­”æœ¯æ–¹æ³•ä»£ç†æä¾›äº†å®Œç¾çš„é€æ˜æ€§

**3. è£…é¥°å™¨è·¯ç”±çš„å·¥å‚æ¨¡å¼**
- ç®€æ´çš„ API èƒŒåæ˜¯å¤æ‚çš„æ³¨å†Œå’Œç¼–è¯‘æœºåˆ¶
- å»¶è¿Ÿæ³¨å†Œæ”¯æŒäº†çµæ´»çš„åº”ç”¨ç»„ç»‡æ–¹å¼
- endpoint é—´æ¥å¯»å€æä¾›äº†å¼ºå¤§çš„æ‰©å±•èƒ½åŠ›

**4. é’©å­å‡½æ•°çš„å±‚çº§æ‰§è¡Œ**
- æä¾›äº†å®Œæ•´çš„è¯·æ±‚ç”Ÿå‘½å‘¨æœŸæ§åˆ¶ç‚¹
- æ”¯æŒäº†åº”ç”¨çº§å’Œè“å›¾çº§çš„åˆ†å±‚å¤„ç†
- å®ç°äº†éä¾µå…¥å¼çš„åŠŸèƒ½æ‰©å±•

## ğŸ“Š æ€§èƒ½ç‰¹å¾åˆ†æ

### è¯·æ±‚å¤„ç†çš„æ€§èƒ½å‰–æ

**æ€§èƒ½å…³é”®ç‚¹**ï¼š
```
WSGIæ¥å£: ~0.1ms  (ç½‘ç»œI/Oå¼€é”€)
ä¸Šä¸‹æ–‡åˆ›å»º: ~0.2ms  (å¯¹è±¡åˆ›å»ºå’Œæ ˆæ“ä½œ)  
è·¯ç”±åŒ¹é…: ~0.1ms   (é¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼)
è§†å›¾æ‰§è¡Œ: å˜åŒ–å¤§   (ä¸šåŠ¡é€»è¾‘å¤æ‚åº¦)
å“åº”æ„å»º: ~0.1ms   (å¯¹è±¡åºåˆ—åŒ–)
ä¸Šä¸‹æ–‡æ¸…ç†: ~0.1ms  (èµ„æºé‡Šæ”¾å’Œä¼šè¯ä¿å­˜)
```

**ä¼˜åŒ–ç­–ç•¥çš„æ•ˆæœ**ï¼š
- **@cached_property**ï¼šé¿å…é‡å¤è®¡ç®—ï¼Œæå‡ 30-50% æ€§èƒ½
- **è·¯ç”±é¢„ç¼–è¯‘**ï¼šç¼–è¯‘æ—¶ä¼˜åŒ–ï¼Œè¿è¡Œæ—¶ O(1) æŸ¥æ‰¾
- **é€‚é…å™¨ç¼“å­˜**ï¼šå‡å°‘å¯¹è±¡åˆ›å»ºå¼€é”€ 60%
- **å»¶è¿ŸåŠ è½½**ï¼šå†…å­˜ä½¿ç”¨å‡å°‘ 40%ï¼Œå¯åŠ¨æ—¶é—´å‡å°‘ 50%

### å†…å­˜ä½¿ç”¨ä¼˜åŒ–

```python
# å†…å­˜ä¼˜åŒ–çš„å…³é”®æŠ€æœ¯
class RequestContext:
    def pop(self, exc=_sentinel):
        """æ™ºèƒ½å†…å­˜æ¸…ç†"""
        try:
            # ä¸šåŠ¡æ¸…ç†é€»è¾‘
            rv = _request_ctx_stack.pop()
        finally:
            # ç¡®ä¿ä¼šè¯ä¿å­˜ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
            if self.session is not None:
                self.app.save_session(self.session, self.request)
            
            # æ¸…ç†å¼•ç”¨ï¼Œå¸®åŠ©åƒåœ¾å›æ”¶
            if clear_request:
                rv.request.environ['werkzeug.request'] = None
```

## ğŸ’¡ å¯¹å…¶ä»–é¡¹ç›®çš„å¯å‘

### Web æ¡†æ¶è®¾è®¡å¯å‘

**1. ä¸Šä¸‹æ–‡ç®¡ç†æ¨¡å¼**
- åˆ†ç¦»ä¸åŒç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€ç®¡ç†
- ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨å®ç°å¹¶å‘å®‰å…¨
- é€æ˜ä»£ç†æä¾›ä¾¿åˆ©çš„å…¨å±€è®¿é—®

**2. æ‰©å±•ç³»ç»Ÿè®¾è®¡**  
- å¤šé‡é›†æˆç‚¹æä¾›ä¸°å¯Œçš„æ‰©å±•èƒ½åŠ›
- æ ‡å‡†åŒ–çš„æ‰©å±•æ¨¡å¼é™ä½å­¦ä¹ æˆæœ¬
- init_app æ¨¡å¼æ”¯æŒåº”ç”¨å·¥å‚æ¨¡å¼

**3. é…ç½®ç³»ç»Ÿé›†æˆ**
- é…ç½®ä¸æ˜¯é™æ€æ•°æ®ï¼Œè€Œæ˜¯å½±å“ç³»ç»Ÿè¡Œä¸ºçš„å‚æ•°
- ç»Ÿä¸€çš„é…ç½®ç®¡ç†ç®€åŒ–äº†ç³»ç»Ÿå¤æ‚åº¦
- ç¯å¢ƒæ„ŸçŸ¥çš„é…ç½®åŠ è½½æ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²

### é€šç”¨æ¶æ„è®¾è®¡å¯å‘

**1. åˆ†å±‚åä½œæ¨¡å¼**
- æ¯å±‚ä¸“æ³¨ç‰¹å®šèŒè´£ï¼Œé€šè¿‡æ¥å£åä½œ
- é¿å…è·¨å±‚ç›´æ¥è°ƒç”¨ï¼Œä¿æŒæ¶æ„æ¸…æ™°
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

**2. å»¶è¿Ÿåˆå§‹åŒ–ç­–ç•¥**
- åªåœ¨éœ€è¦æ—¶åˆ›å»ºå¤æ‚å¯¹è±¡
- @cached_property æ¨¡å¼é¿å…é‡å¤è®¡ç®—
- æé«˜ç³»ç»Ÿå¯åŠ¨æ€§èƒ½å’Œå†…å­˜æ•ˆç‡

**3. å¯æ‰©å±•æ€§è®¾è®¡**
- é¢„ç•™æ‰©å±•ç‚¹ï¼Œæ”¯æŒç¬¬ä¸‰æ–¹åŠŸèƒ½å¢å¼º
- æ ‡å‡†åŒ–çš„æ‰©å±•æ¨¡å¼å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- å‘åå…¼å®¹çš„æ¥å£æ¼”è¿›ç­–ç•¥

## ğŸ“š æ€»ç»“

Flask çš„æ ¸å¿ƒæœºåˆ¶è®¾è®¡ä½“ç°äº†æ·±åˆ»çš„å·¥ç¨‹æ™ºæ…§å’Œæ¶æ„æ´å¯Ÿã€‚é€šè¿‡åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€è¯·æ±‚å¤„ç†æµç¨‹ã€è·¯ç”±ç³»ç»Ÿå’Œä¸Šä¸‹æ–‡ç®¡ç†çš„ååŒå·¥ä½œï¼ŒFlask åœ¨ç®€æ´æ€§å’ŒåŠŸèƒ½æ€§ä¹‹é—´æ‰¾åˆ°äº†å®Œç¾çš„å¹³è¡¡ç‚¹ã€‚

å…¶æˆåŠŸçš„å…³é”®åœ¨äºï¼š
- **é—®é¢˜åŸŸçš„æ·±åº¦ç†è§£**ï¼šå‡†ç¡®è¯†åˆ« Web å¼€å‘çš„æ ¸å¿ƒé—®é¢˜
- **çº¦æŸæ¡ä»¶çš„ä¼˜é›…å“åº”**ï¼šå°†æŠ€æœ¯çº¦æŸè½¬åŒ–ä¸ºè®¾è®¡ä¼˜åŠ¿  
- **æœºåˆ¶é—´çš„ååŒè®¾è®¡**ï¼šå„ä¸ªæœºåˆ¶ç›¸äº’æ”¯æ’‘ï¼Œå½¢æˆæœ‰æœºæ•´ä½“
- **æ‰©å±•æ€§çš„å‰ç»è€ƒè™‘**ï¼šä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•é¢„ç•™ç©ºé—´

è¿™äº›è®¾è®¡ç»éªŒå¯¹ä»»ä½•å¤æ‚ç³»ç»Ÿçš„æ¶æ„è®¾è®¡éƒ½å…·æœ‰é‡è¦çš„å‚è€ƒä»·å€¼ã€‚

---

**ä¸‹ä¸€ç¯‡**ï¼š[L3 - å…³é”®å®ç°ç»†èŠ‚åˆ†æ](./04-L3-å…³é”®å®ç°.md)

**ç›¸å…³åˆ†æ**ï¼š
- [L1 - ç³»ç»Ÿå…¨æ™¯åˆ†æ](./02-L1-ç³»ç»Ÿå…¨æ™¯.md)
- [Flask æºç åˆ†æä»·å€¼ä¸è·¯çº¿å›¾](./01-Flaskå­¦ä¹ ä»·å€¼ä¸è·¯çº¿å›¾.md)