# Flaskè£…é¥°å™¨ç³»ç»Ÿæ·±åº¦è§£æ

## ğŸ¯ è£…é¥°å™¨ç³»ç»Ÿçš„å·¥ç¨‹è‰ºæœ¯

åŸºäºå¯¹Flaskæºç çš„æ·±å…¥åˆ†æï¼Œè£…é¥°å™¨ç³»ç»Ÿå±•ç°äº†Flaskåœ¨è¯­æ³•ç³–å’Œæ§åˆ¶åŠ›ä¹‹é—´çš„ç²¾å¦™å¹³è¡¡ã€‚

### æ ¸å¿ƒå®ç°æœºåˆ¶

**è£…é¥°å™¨å·¥å‚æ¨¡å¼çš„ç²¾å¦™è®¾è®¡** (`flask/sansio/scaffold.py:336`)ï¼š

```python
def route(self, rule: str, **options: t.Any) -> t.Callable[[T_route], T_route]:
    def decorator(f: T_route) -> T_route:
        endpoint = options.pop("endpoint", None)
        self.add_url_rule(rule, endpoint, f, **options)
        return f
    return decorator
```

**è®¾è®¡æ™ºæ…§**ï¼š
- **å»¶è¿Ÿç»‘å®šç­–ç•¥**: è£…é¥°å™¨åˆ›å»ºæ—¶ä¸ç«‹å³æ³¨å†Œè·¯ç”±ï¼Œè€Œæ˜¯åœ¨åº”ç”¨å¯åŠ¨æ—¶æ³¨å†Œï¼Œæ”¯æŒåŠ¨æ€é…ç½®
- **å‡½æ•°èº«ä»½ä¿æŠ¤**: è¿”å›åŸå§‹å‡½æ•°è€ŒéåŒ…è£…å‡½æ•°ï¼Œä¿æŒè°ƒè¯•å’Œå…ƒä¿¡æ¯çš„å®Œæ•´æ€§
- **å‚æ•°å¤„ç†ä¼˜é›…æ€§**: ä½¿ç”¨`**options`ç»Ÿä¸€å¤„ç†ï¼Œå†é€šè¿‡`pop`æå–ç‰¹å®šå‚æ•°

**é’©å­è£…é¥°å™¨çš„ç®€æ´å®ç°** (`flask/sansio/scaffold.py:483`)ï¼š

```python
def before_request(self, f: T_before_request) -> T_before_request:
    self.before_request_funcs.setdefault(None, []).append(f)
    return f
```

### è·¯ç”±æ³¨å†Œçš„æ ¸å¿ƒé€»è¾‘

**add_url_ruleçš„æ™ºèƒ½å¤„ç†** (`flask/sansio/app.py:605-661`)ï¼š

```python
def add_url_rule(self, rule: str, endpoint: str | None = None, view_func: ft.RouteCallable | None = None, **options):
    if endpoint is None:
        endpoint = _endpoint_from_view_func(view_func)
    options["endpoint"] = endpoint
    methods = options.pop("methods", None)
    
    # æ™ºèƒ½æ–¹æ³•å¤„ç†
    if methods is None:
        methods = getattr(view_func, "methods", None) or ("GET",)
    methods = {item.upper() for item in methods}
    
    # è‡ªåŠ¨OPTIONSå¤„ç†
    required_methods: set[str] = set(getattr(view_func, "required_methods", ()))
    if provide_automatic_options is None:
        if "OPTIONS" not in methods and self.config["PROVIDE_AUTOMATIC_OPTIONS"]:
            provide_automatic_options = True
            required_methods.add("OPTIONS")
    
    methods |= required_methods
    rule_obj = self.url_rule_class(rule, methods=methods, **options)
    self.url_map.add(rule_obj)
    
    # ç«¯ç‚¹å†²çªæ£€æµ‹
    if view_func is not None:
        old_func = self.view_functions.get(endpoint)
        if old_func is not None and old_func != view_func:
            raise AssertionError(f"View function mapping is overwriting an existing endpoint function: {endpoint}")
        self.view_functions[endpoint] = view_func
```

### è£…é¥°å™¨æ¨¡å¼åˆ†ç±»

Flaské‡‡ç”¨äº†ä¸¤ç§ä¸åŒçš„è£…é¥°å™¨æ¨¡å¼ï¼š

#### A. è£…é¥°å™¨å·¥å‚æ¨¡å¼ (Decorator Factory Pattern)
- `@app.route(rule, **options)` 
- `@app.errorhandler(code_or_exception)`

**ç‰¹ç‚¹**ï¼š
- æ¥å—å‚æ•°é…ç½®
- è¿”å›çœŸæ­£çš„è£…é¥°å™¨å‡½æ•°
- æ”¯æŒå¤æ‚çš„é…ç½®é€‰é¡¹

#### B. ç›´æ¥è£…é¥°å™¨æ¨¡å¼ (Direct Decorator Pattern)  
- `@app.before_request`
- `@app.after_request`
- `@app.teardown_request`

**ç‰¹ç‚¹**ï¼š
- ç›´æ¥è£…é¥°ç›®æ ‡å‡½æ•°
- ç®€æ´çš„è¯­æ³•
- é€‚ç”¨äºç®€å•çš„é’©å­æ³¨å†Œ

### æ¡†æ¶å¯¹æ¯”

| æ¡†æ¶ | è£…é¥°å™¨ç­–ç•¥ | è®¾è®¡ç‰¹ç‚¹ |
|------|------------|----------|
| **Flask** | è£…é¥°å™¨å·¥å‚ + ç›´æ¥è£…é¥°å™¨ | å»¶è¿Ÿç»‘å®šã€å‡½æ•°ä¿æŠ¤ã€ç±»å‹å®‰å…¨ |
| **Django** | å‡½æ•°è£…é¥°å™¨ | é¢å‘ç±»çš„è£…é¥°å™¨ï¼Œä¸­é—´ä»¶æ¨¡å¼ |
| **FastAPI** | ä¾èµ–æ³¨å…¥è£…é¥°å™¨ | ç±»å‹é©±åŠ¨ã€è‡ªåŠ¨éªŒè¯ |
| **Express.js** | ä¸­é—´ä»¶å‡½æ•° | å‡½æ•°å¼ã€é“¾å¼è°ƒç”¨ |

### ç«¯ç‚¹å¤„ç†çš„æ™ºèƒ½åŒ–

**ç«¯ç‚¹åç§°çš„è‡ªåŠ¨ç”Ÿæˆ**ï¼š

```python
def _endpoint_from_view_func(view_func: ft.RouteCallable) -> str:
    """ä»è§†å›¾å‡½æ•°æå–ç«¯ç‚¹åç§°"""
    assert view_func is not None, "expected view func if endpoint is not provided."
    return view_func.__name__
```

**è§†å›¾å‡½æ•°çš„å…ƒä¿¡æ¯ä¿æŠ¤**ï¼š

```python
# Flaskä¿æŠ¤åŸå§‹å‡½æ•°çš„å®Œæ•´æ€§
@app.route('/hello')
def hello():
    """è¯´æ˜æ–‡æ¡£"""
    return 'Hello World!'

# hello.__name__ == 'hello'
# hello.__doc__ == 'è¯´æ˜æ–‡æ¡£'
# hello.__module__ ä¿æŒä¸å˜
```

### è“å›¾è£…é¥°å™¨çš„å‘½åç©ºé—´ç®¡ç†

**è“å›¾ä¸­çš„è£…é¥°å™¨æ³¨å†Œ**ï¼š

```python
# Blueprint.routeçš„å®ç°
def route(self, rule: str, **options: t.Any) -> t.Callable[[T_route], T_route]:
    def decorator(f: T_route) -> T_route:
        endpoint = options.get("endpoint")
        if endpoint is None:
            endpoint = f.__name__
        # è“å›¾è£…é¥°å™¨ä½¿ç”¨recordæœºåˆ¶å»¶è¿Ÿæ³¨å†Œ
        self.record(lambda s: s.add_url_rule(rule, endpoint, f, **options))
        return f
    return decorator
```

**å‘½åç©ºé—´çš„è‡ªåŠ¨ç®¡ç†**ï¼š

```python
# è“å›¾æ³¨å†Œæ—¶è‡ªåŠ¨æ·»åŠ å‰ç¼€
def register(self, app: Flask, options: t.Any) -> None:
    first_registration = False
    if self.name in app.blueprints:
        existing_bp = app.blueprints[self.name]
        if existing_bp is not self:
            raise AssertionError("A name collision occurred between blueprints")
    else:
        app.blueprints[self.name] = self
        first_registration = True
    
    # åº”ç”¨æ‰€æœ‰å»¶è¿Ÿçš„æ³¨å†Œå‡½æ•°
    for deferred in self.deferred_functions:
        deferred(BlueprintSetupState(self, app, options, first_registration))
```

### é”™è¯¯å¤„ç†è£…é¥°å™¨çš„ç±»å‹æ”¯æŒ

**errorhandlerçš„å¤šç±»å‹æ”¯æŒ**ï¼š

```python
def errorhandler(self, code_or_exception: type[Exception] | int) -> t.Callable[[T_errorhandler], T_errorhandler]:
    """æ³¨å†Œé”™è¯¯å¤„ç†å™¨"""
    def decorator(f: T_errorhandler) -> T_errorhandler:
        self._register_error_handler(None, code_or_exception, f)
        return f
    return decorator

def _register_error_handler(self, key: str | None, code_or_exception: type[Exception] | int, f: ft.ErrorHandlerCallable) -> None:
    """å†…éƒ¨é”™è¯¯å¤„ç†å™¨æ³¨å†Œé€»è¾‘"""
    if isinstance(code_or_exception, int):
        assert 400 <= code_or_exception <= 599, "é”™è¯¯ä»£ç å¿…é¡»æ˜¯æœ‰æ•ˆçš„HTTPçŠ¶æ€ç "
    exc_class, code = self._get_exc_class_and_code(code_or_exception)
    self.error_handler_spec[key][code][exc_class] = f
```

### å¯å€Ÿé‰´çš„è®¾è®¡æ¨¡å¼

1. **æ··åˆè£…é¥°å™¨ç­–ç•¥**: æ ¹æ®å¤æ‚åº¦é€‰æ‹©è£…é¥°å™¨å·¥å‚æˆ–ç›´æ¥è£…é¥°å™¨
2. **å…ƒä¿¡æ¯ä¿æŠ¤æœºåˆ¶**: ä¿æŒåŸå‡½æ•°å±æ€§å®Œæ•´æ€§
3. **è“å›¾å‘½åç©ºé—´**: ä½¿ç”¨`setdefault(None, [])`ç®¡ç†å‘½åç©ºé—´
4. **ç«¯ç‚¹å†²çªæ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹å’Œé˜²æ­¢ç«¯ç‚¹é‡å¤æ³¨å†Œ
5. **å»¶è¿Ÿç»‘å®šæ¨¡å¼**: æ”¯æŒåŠ¨æ€é…ç½®å’Œè“å›¾ç³»ç»Ÿ
6. **ç±»å‹å®‰å…¨è®¾è®¡**: é€šè¿‡æ³›å‹ä¿æŒç±»å‹æ¨æ–­

### è£…é¥°å™¨ç³»ç»Ÿçš„æ‰©å±•ä»·å€¼

**ä¸ºæ¡†æ¶æ‰©å±•æä¾›çš„èƒ½åŠ›**ï¼š

- **è·¯ç”±è£…é¥°å™¨**: æ ¸å¿ƒçš„URLæ˜ å°„æœºåˆ¶
- **é’©å­è£…é¥°å™¨**: è¯·æ±‚ç”Ÿå‘½å‘¨æœŸçš„å¹²é¢„ç‚¹
- **é”™è¯¯è£…é¥°å™¨**: ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- **æ¨¡æ¿è£…é¥°å™¨**: ä¸Šä¸‹æ–‡å¤„ç†å™¨æ³¨å†Œ
- **CLIè£…é¥°å™¨**: å‘½ä»¤è¡Œæ¥å£æ‰©å±•

### è®¾è®¡æ™ºæ…§æ€»ç»“

Flaskçš„è£…é¥°å™¨ç³»ç»Ÿä½“ç°äº†ä»¥ä¸‹è®¾è®¡æ™ºæ…§ï¼š

1. **æ¸è¿›å¼å¤æ‚åº¦**: ä»ç®€å•çš„ç›´æ¥è£…é¥°å™¨åˆ°å¤æ‚çš„è£…é¥°å™¨å·¥å‚
2. **å‡½æ•°å¼ä¸é¢å‘å¯¹è±¡çš„å¹³è¡¡**: è£…é¥°å™¨è¯­æ³•çš„å‡½æ•°å¼ç‰¹æ€§ä¸å¯¹è±¡æ–¹æ³•çš„ç»“åˆ
3. **å»¶è¿Ÿæ‰§è¡Œçš„ä¼˜é›…å®ç°**: é€šè¿‡é—­åŒ…å’Œrecordæœºåˆ¶å®ç°å»¶è¿Ÿç»‘å®š
4. **ç±»å‹ç³»ç»Ÿçš„å‹å¥½æ”¯æŒ**: ä¿æŒIDEå’Œç±»å‹æ£€æŸ¥å™¨çš„å®Œæ•´æ”¯æŒ
5. **è°ƒè¯•å‹å¥½çš„è®¾è®¡**: ä¿æŠ¤åŸå‡½æ•°çš„å…ƒä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•å’Œintrospection

è¿™ç§è£…é¥°å™¨ç³»ç»Ÿè®¾è®¡ä¸ä»…é€‚ç”¨äºWebæ¡†æ¶ï¼Œåœ¨ä»»ä½•éœ€è¦æä¾›ç®€æ´APIçš„åº“è®¾è®¡ä¸­éƒ½å…·æœ‰å‚è€ƒä»·å€¼ã€‚