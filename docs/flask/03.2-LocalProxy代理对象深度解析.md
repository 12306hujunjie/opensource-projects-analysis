# Flask LocalProxyä»£ç†å¯¹è±¡æ·±åº¦è§£æ

## ğŸ”„ LocalProxyä»£ç†å¯¹è±¡çš„é€æ˜é­”æ³•

LocalProxyæ˜¯Flaskä¸­æœ€ç²¾å¦™çš„è®¾è®¡ä¹‹ä¸€ï¼Œå®ƒé€šè¿‡ä»£ç†æ¨¡å¼å®ç°äº†å…¨å±€å˜é‡çš„çº¿ç¨‹å®‰å…¨è®¿é—®ï¼ŒåŒæ—¶ä¿æŒäº†APIçš„ç®€æ´æ€§ã€‚

### æ ¸å¿ƒå®ç°åˆ†æ

**å…¨å±€å˜é‡çš„çº¿ç¨‹å®‰å…¨æ›¿ä»£** (`flask/globals.py:28-50`)ï¼š

```python
_cv_app: ContextVar[AppContext] = ContextVar("flask.app_ctx")
_cv_request: ContextVar[RequestContext] = ContextVar("flask.request_ctx")

# åº”ç”¨ä¸Šä¸‹æ–‡ç›¸å…³ä»£ç†
current_app: Flask = LocalProxy(_cv_app, "app", unbound_message=_no_app_msg)
g: _AppCtxGlobals = LocalProxy(_cv_app, "g", unbound_message=_no_app_msg)

# è¯·æ±‚ä¸Šä¸‹æ–‡ç›¸å…³ä»£ç†
request: Request = LocalProxy(_cv_request, "request", unbound_message=_no_req_msg)
session: SessionMixin = LocalProxy(_cv_request, "session", unbound_message=_no_req_msg)
```

**é”™è¯¯æ¶ˆæ¯çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥**ï¼š

```python
_no_app_msg = """\
Working outside of application context.

This typically means that you attempted to use functionality that needed
the current application. To solve this, set up an application context
with app.app_context(). See the documentation for more information.\
"""

_no_req_msg = """\
Working outside of request context.

This typically means that you attempted to use functionality that needed
an active HTTP request. Consult the documentation on testing for
information about how to avoid this problem.\
"""
```

### LocalProxyçš„è®¾è®¡æ™ºæ…§

#### 1. ContextVaré›†æˆä¼˜åŠ¿

**ç°ä»£å¼‚æ­¥æ”¯æŒ**ï¼š
```python
import asyncio
import contextvars

# ContextVaråœ¨å¼‚æ­¥ç¯å¢ƒä¸­è‡ªåŠ¨å·¥ä½œ
async def async_view():
    # current_appåœ¨asyncå‡½æ•°ä¸­æ­£å¸¸å·¥ä½œ
    logger = current_app.logger
    logger.info("This works in async context!")
```

**å¯¹æ¯”threading.localçš„ä¼˜åŠ¿**ï¼š
```python
# ä¼ ç»Ÿæ–¹å¼ï¼šthreading.local
import threading
local = threading.local()

# é—®é¢˜ï¼šåœ¨å¼‚æ­¥ç¯å¢ƒä¸­ä¸å·¥ä½œ
async def broken_async():
    local.value = "test"  # åœ¨ä¸åŒçš„async taskä¸­å¯èƒ½ä¸¢å¤±

# Flaskæ–¹å¼ï¼šContextVar
_cv_app: ContextVar[AppContext] = ContextVar("flask.app_ctx")
# ä¼˜åŠ¿ï¼šåŸç”Ÿæ”¯æŒasyncioï¼Œè‡ªåŠ¨åœ¨async taské—´ä¼ é€’ä¸Šä¸‹æ–‡
```

#### 2. å±æ€§ä»£ç†æ¨¡å¼

**å¤šå±‚å±æ€§è®¿é—®æ”¯æŒ**ï¼š
```python
# LocalProxyåˆå§‹åŒ–æ”¯æŒå±æ€§é“¾
current_app = LocalProxy(_cv_app, "app")  # è®¿é—®AppContext.app
g = LocalProxy(_cv_app, "g")              # è®¿é—®AppContext.g
request = LocalProxy(_cv_request, "request")  # è®¿é—®RequestContext.request
```

**é€æ˜ä»£ç†å®ç°**ï¼š
```python
# è¿™äº›æ“ä½œçœ‹èµ·æ¥åƒç›´æ¥è®¿é—®å¯¹è±¡
app_name = current_app.name           # å®é™…ï¼š_cv_app.get().app.name
user_id = g.user_id                   # å®é™…ï¼š_cv_app.get().g.user_id
path = request.path                   # å®é™…ï¼š_cv_request.get().request.path
```

### é­”æœ¯æ–¹æ³•ä»£ç†æœºåˆ¶

LocalProxyå®ç°äº†å®Œæ•´çš„é­”æœ¯æ–¹æ³•ä»£ç†ï¼Œå®ç°é€æ˜è®¿é—®ï¼š

```python
# è¿™äº›æ“ä½œéƒ½é€šè¿‡LocalProxyçš„é­”æœ¯æ–¹æ³•ä»£ç†å®ç°
request.path == '/hello'      # __getattr__ + __eq__
request.args['name']          # __getattr__ + __getitem__  
len(request.form)             # __getattr__ + __len__
str(request.method)           # __getattr__ + __str__
bool(request.is_json)         # __getattr__ + __bool__
request.method in ['GET']     # __getattr__ + __contains__
```

**é­”æœ¯æ–¹æ³•çš„å®Œæ•´è¦†ç›–**ï¼š

```python
class LocalProxy:
    # å±æ€§è®¿é—®
    def __getattr__(self, name): ...
    def __setattr__(self, name, value): ...
    def __delattr__(self, name): ...
    
    # å®¹å™¨åè®®
    def __getitem__(self, key): ...
    def __setitem__(self, key, value): ...
    def __delitem__(self, key): ...
    def __contains__(self, item): ...
    def __len__(self): ...
    def __iter__(self): ...
    
    # æ¯”è¾ƒæ“ä½œ
    def __eq__(self, other): ...
    def __ne__(self, other): ...
    def __lt__(self, other): ...
    def __le__(self, other): ...
    def __gt__(self, other): ...
    def __ge__(self, other): ...
    
    # æ•°å€¼æ“ä½œ
    def __add__(self, other): ...
    def __sub__(self, other): ...
    def __mul__(self, other): ...
    def __truediv__(self, other): ...
    def __mod__(self, other): ...
    
    # ç±»å‹è½¬æ¢
    def __str__(self): ...
    def __repr__(self): ...
    def __bool__(self): ...
    def __int__(self): ...
    def __float__(self): ...
    
    # è°ƒç”¨åè®®
    def __call__(self, *args, **kwargs): ...
```

### é”™è¯¯å¤„ç†çš„ä¸Šä¸‹æ–‡æ„ŸçŸ¥

**æ™ºèƒ½é”™è¯¯æ£€æµ‹**ï¼š

```python
def _get_current_object(self) -> t.Any:
    """è·å–å½“å‰ä»£ç†çš„å®é™…å¯¹è±¡"""
    try:
        obj = self.__local()  # å°è¯•è·å–ä¸Šä¸‹æ–‡å¯¹è±¡
    except LookupError:
        if self.__name__ is None:
            raise RuntimeError(self.__fallback__()) from None
        raise AttributeError(f"No '{self.__name__}' in context") from None
    return obj
```

**åˆ†å±‚é”™è¯¯æ¶ˆæ¯**ï¼š

```python
# åº”ç”¨ä¸Šä¸‹æ–‡é”™è¯¯
try:
    current_app.config
except RuntimeError:
    # æä¾›è§£å†³æ–¹æ¡ˆçš„é”™è¯¯æ¶ˆæ¯
    """
    Working outside of application context.
    
    This typically means that you attempted to use functionality that needed
    the current application. To solve this, set up an application context
    with app.app_context().
    """

# è¯·æ±‚ä¸Šä¸‹æ–‡é”™è¯¯  
try:
    request.method
except RuntimeError:
    # é’ˆå¯¹æ€§çš„é”™è¯¯æŒ‡å¯¼
    """
    Working outside of request context.
    
    This typically means that you attempted to use functionality that needed
    an active HTTP request. Consult the documentation on testing for
    information about how to avoid this problem.
    """
```

### ç±»å‹ç³»ç»Ÿå…¼å®¹æ€§

**ç±»å‹æ³¨è§£çš„å·§å¦™å¤„ç†**ï¼š

```python
# Flaskå…¨å±€å˜é‡çš„ç±»å‹å£°æ˜
current_app: Flask = LocalProxy(_cv_app, "app")  # type: ignore[assignment]
request: Request = LocalProxy(_cv_request, "request")  # type: ignore[assignment]

# ä¸ºä»€ä¹ˆéœ€è¦type: ignoreï¼Ÿ
# LocalProxyä¸æ˜¯Flask/Requestçš„å­ç±»ï¼Œä½†åœ¨è¿è¡Œæ—¶è¡¨ç°å¾—åƒ
# è¿™æ ·IDEå’Œç±»å‹æ£€æŸ¥å™¨èƒ½æä¾›æ­£ç¡®çš„ä»£ç è¡¥å…¨å’Œç±»å‹æ£€æŸ¥
```

**å¼€å‘æ—¶çš„ç±»å‹æ”¯æŒ**ï¼š

```python
# IDEèƒ½æ­£ç¡®è¯†åˆ«ç±»å‹å’Œæ–¹æ³•
current_app.config['SECRET_KEY']  # IDEçŸ¥é“configæ˜¯å­—å…¸
request.method                    # IDEçŸ¥é“methodæ˜¯å­—ç¬¦ä¸²
g.user_id                        # IDEçŸ¥é“gæ˜¯_AppCtxGlobals
```

### æ¡†æ¶å¯¹æ¯”

| æ¡†æ¶ | å…¨å±€å˜é‡ç­–ç•¥ | çº¿ç¨‹å®‰å…¨æœºåˆ¶ | å¼‚æ­¥æ”¯æŒ |
|------|-------------|-------------|---------|
| **Flask** | LocalProxy + ContextVar | ä»£ç†æ¨¡å¼ï¼Œå®Œå…¨é€æ˜ | âœ… åŸç”Ÿæ”¯æŒ |
| **Django** | ç›´æ¥å…¨å±€å˜é‡ | è¯·æ±‚çº¿ç¨‹ç»‘å®š | âš ï¸ éƒ¨åˆ†æ”¯æŒ |
| **FastAPI** | ä¾èµ–æ³¨å…¥ | æ˜¾å¼ä¼ é€’ï¼Œæ— å…¨å±€çŠ¶æ€ | âœ… åŸç”Ÿæ”¯æŒ |
| **Starlette** | ä¸Šä¸‹æ–‡å˜é‡ | ContextVaråŸç”Ÿæ”¯æŒ | âœ… åŸç”Ÿæ”¯æŒ |

### LocalProxyçš„æ€§èƒ½è€ƒé‡

**å†…å­˜å¼€é”€åˆ†æ**ï¼š

```python
# æ¯ä¸ªLocalProxyå®ä¾‹çš„å†…å­˜å ç”¨
class LocalProxy:
    __slots__ = (
        "__local",        # ContextVaræˆ–callable
        "__name__",       # å±æ€§åç§°
        "__fallback__",   # é”™è¯¯æ¶ˆæ¯å‡½æ•°
    )
    
# ç›¸æ¯”ç›´æ¥å…¨å±€å˜é‡å¢åŠ çš„å¼€é”€ï¼š
# 1. æ¯æ¬¡è®¿é—®å¤šä¸€å±‚å‡½æ•°è°ƒç”¨
# 2. ContextVar.get()çš„æŸ¥æ‰¾å¼€é”€
# 3. å±æ€§è§£æçš„åŠ¨æ€æ€§

# ä½†å¸¦æ¥çš„å¥½å¤„ï¼š
# 1. å®Œå…¨çš„çº¿ç¨‹å®‰å…¨
# 2. å¼‚æ­¥ç¯å¢ƒæ”¯æŒ
# 3. ä¸Šä¸‹æ–‡éš”ç¦»
# 4. ä¼˜é›…çš„é”™è¯¯å¤„ç†
```

**è®¿é—®æ€§èƒ½ä¼˜åŒ–**ï¼š

```python
# é«˜é¢‘è®¿é—®çš„ä¼˜åŒ–ç­–ç•¥
def optimized_view():
    # ç¼“å­˜LocalProxyè§£æçš„å¯¹è±¡
    app = current_app._get_current_object()
    req = request._get_current_object()
    
    # åç»­ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„å¯¹è±¡
    for i in range(1000):
        # é¿å…é‡å¤çš„LocalProxyè§£æ
        value = app.config['KEY'] + req.method
```

### å®é™…ä½¿ç”¨æ¨¡å¼

**æµ‹è¯•ç¯å¢ƒä¸­çš„åº”ç”¨**ï¼š

```python
# å•å…ƒæµ‹è¯•ä¸­çš„ä¸Šä¸‹æ–‡ç®¡ç†
def test_view():
    with app.app_context():
        # current_appç°åœ¨å¯ç”¨
        assert current_app.name == 'test_app'
        
    with app.test_request_context('/hello'):
        # requestå’Œsessionç°åœ¨å¯ç”¨
        assert request.path == '/hello'
        assert 'user' not in session
```

**åå°ä»»åŠ¡ä¸­çš„ä½¿ç”¨**ï¼š

```python
# Celeryä»»åŠ¡ä¸­ä½¿ç”¨Flaskä¸Šä¸‹æ–‡
@celery.task
def background_task(data):
    with app.app_context():
        # åœ¨åå°ä»»åŠ¡ä¸­ä½¿ç”¨FlaskåŠŸèƒ½
        current_app.logger.info(f"Processing {data}")
        result = some_flask_function(data)
        return result
```

### å¯å€Ÿé‰´çš„è®¾è®¡æ¨¡å¼

1. **ä»£ç†æ¨¡å¼çš„å®Œæ•´å®ç°**: é­”æœ¯æ–¹æ³•å…¨è¦†ç›–ï¼Œå®ç°é€æ˜ä»£ç†
2. **ä¸Šä¸‹æ–‡æ„ŸçŸ¥é”™è¯¯å¤„ç†**: æ ¹æ®ä¸Šä¸‹æ–‡æä¾›é’ˆå¯¹æ€§é”™è¯¯ä¿¡æ¯
3. **å¼‚æ­¥å…¼å®¹è®¾è®¡**: ContextVarå¤©ç„¶æ”¯æŒasyncio
4. **ç±»å‹ç³»ç»Ÿå…¼å®¹**: é€šè¿‡type: ignoreä¿æŒå¼€å‘æ—¶ç±»å‹æ£€æŸ¥
5. **æ€§èƒ½ä¸ä¾¿åˆ©çš„å¹³è¡¡**: å°‘é‡æ€§èƒ½å¼€é”€æ¢å–å·¨å¤§çš„ä¾¿åˆ©æ€§
6. **é”™è¯¯æ¶ˆæ¯çš„æ•™è‚²æ€§**: ä¸ä»…æŒ‡å‡ºé—®é¢˜ï¼Œè¿˜æä¾›è§£å†³æ–¹æ¡ˆ

### æ‰©å±•åº”ç”¨åœºæ™¯

**è‡ªå®šä¹‰LocalProxyçš„ä½¿ç”¨**ï¼š

```python
# åˆ›å»ºè‡ªå®šä¹‰çš„ä¸Šä¸‹æ–‡ä»£ç†
from flask import LocalProxy
from contextvars import ContextVar

_current_user: ContextVar[User] = ContextVar('current_user')
current_user = LocalProxy(_current_user)

# åœ¨ä¸­é—´ä»¶ä¸­è®¾ç½®
@app.before_request
def load_user():
    user = get_user_from_session()
    _current_user.set(user)

# åœ¨è§†å›¾ä¸­ä½¿ç”¨
@app.route('/profile')
def profile():
    return f"Hello {current_user.name}"  # é€æ˜è®¿é—®
```

### è®¾è®¡å“²å­¦æ€»ç»“

LocalProxyä½“ç°äº†Flaskçš„æ ¸å¿ƒè®¾è®¡å“²å­¦ï¼š

1. **ç®€æ´æ€§ä¼˜å…ˆ**: å¤æ‚çš„å®ç°éšè—åœ¨ç®€å•çš„APIèƒŒå
2. **å¼€å‘ä½“éªŒ**: å…¨å±€å˜é‡çš„ä¾¿åˆ©æ€§ï¼Œæ²¡æœ‰çº¿ç¨‹å®‰å…¨çš„çƒ¦æ¼
3. **æ¸è¿›å¼å¤æ‚åº¦**: ç®€å•ä½¿ç”¨æ—¶æ— éœ€äº†è§£å®ç°ç»†èŠ‚
4. **å‘å‰å…¼å®¹**: ContextVarçš„å¼•å…¥ä¸ç ´åç°æœ‰ä»£ç 
5. **é”™è¯¯å‹å¥½**: æ¸…æ™°çš„é”™è¯¯æ¶ˆæ¯å’Œè§£å†³æŒ‡å¯¼

LocalProxyä¸ä»…è§£å†³äº†Webåº”ç”¨ä¸­çš„ä¸Šä¸‹æ–‡è®¿é—®é—®é¢˜ï¼Œå…¶è®¾è®¡æ€æƒ³åœ¨ä»»ä½•éœ€è¦çº¿ç¨‹å®‰å…¨å…¨å±€çŠ¶æ€çš„åœºæ™¯ä¸­éƒ½å…·æœ‰å‚è€ƒä»·å€¼ã€‚